<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Reservas - AABB Aracaju</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003399">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- TELA DE LOGIN --- */
        #login-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #003399 0%, #1a53ff 100%);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            padding: 20px; box-sizing: border-box;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 100%; max-width: 350px; text-align: center;
        }
        .login-logo { max-width: 180px; height: auto; display: block; margin: 0 auto 20px auto; }
        .login-box h2 { margin-bottom: 5px; color: #003399; font-weight: 700; }
        .login-box p { color: #666; margin-bottom: 25px; font-size: 13px; }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd;
            border-radius: 5px; box-sizing: border-box; background-color: #f9f9f9;
        }
        .login-box input:focus { border-color: #ffc107; outline: none; background-color: #fff; }
        .login-btn {
            width: 100%; padding: 12px; background: #003399; color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
        }
        #login-error { color: #dc3545; margin-top: 10px; display: none; font-size: 12px;}

        /* --- AREA DO SISTEMA --- */
        #app-container { display: none; padding: 20px; flex-grow: 1; }
        .container {
            max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px 35px;
            border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); position: relative;
        }

        /* Header */
        .app-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            border-bottom: 2px solid #ffc107; padding-bottom: 15px;
        }
        .header-title h1 { text-align: left; margin: 0; color: #003399; font-size: 24px; }
        .header-title span { font-size: 12px; color: #666; }
        .btn-logout { background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Formul√°rio */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;
        }
        #btn-form-reserva {
            width: 100%; padding: 12px; background-color: #28a745; color: #fff; border: none;
            border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px;
        }
        #btn-form-reserva:disabled { background-color: #94d3a2; }

        /* View Toggle e Filtros */
        .view-toggle-container {
            display: flex; justify-content: center; margin-bottom: 20px;
            background: #e9ecef; padding: 5px; border-radius: 8px; width: fit-content; margin-left: auto; margin-right: auto;
        }
        .view-btn { padding: 10px 25px; border: none; cursor: pointer; font-weight: bold; border-radius: 6px; background: transparent; color: #495057; }
        .view-btn.active { background: #fff; color: #003399; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .filtros-container {
            display: flex; justify-content: center; align-items: flex-end; margin-bottom: 25px;
            flex-wrap: wrap; gap: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;
        }
        .filtro-item { display: flex; flex-direction: column; }
        .filtro-item input, .filtro-item select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* --- Tabela --- */
        .tabela-wrapper { overflow-x: auto; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 0; table-layout: fixed; background: white; }
        table, th, td { border: 1px solid #dee2e6; }
        th, td { padding: 12px 15px; text-align: left; word-wrap: break-word; }
        th { background-color: #f1f3f5; color: #495057; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        
        /* Larguras Desktop */
        th:nth-child(1), td:nth-child(1) { width: 90px; }
        th:nth-child(2), td:nth-child(2) { width: 18%; }
        th:nth-child(3), td:nth-child(3) { width: 15%; }
        th:nth-child(4), td:nth-child(4) { width: 110px; }
        th:nth-child(5), td:nth-child(5) { width: 25%; }
        th:nth-child(6), td:nth-child(6) { width: 100px; text-align: center;}
        th:nth-child(7), td:nth-child(7) { width: 100px; text-align: center;}

        /* Cores e Badges */
        .confirmado-row { background-color: #d4edda; }
        .reservado-row { background-color: #fff3cd; }
        .cancelado-row { background-color: #f8d7da; }
        .realizado-row { background-color: #e2e3e5; }
        .status-badge {
            display: inline-block; padding: 5px 10px; border-radius: 50px; font-size: 11px; font-weight: bold;
            color: white; cursor: pointer; text-align: center; min-width: 80px;
        }
        .badge-reservado { background-color: #007bff; }
        .badge-confirmado { background-color: #28a745; }
        .badge-cancelado { background-color: #dc3545; }
        .badge-realizado { background-color: #6c757d; }
        
        /* Bot√µes A√ß√£o */
        .botoes-acao { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .botoes-acao button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-pdf { background-color: #17a2b8; }
        .btn-csv { background-color: #218838; }
        .btn-fechar { background-color: #6c757d; }
        .btn-editar, .btn-excluir { padding: 4px 8px; border: none; cursor: pointer; border-radius: 3px; font-size: 11px; margin: 2px; }
        .btn-editar { background-color: #ffc107; color: #000; }
        .btn-excluir { background-color: #dc3545; color: #fff; }
        .btn-cancelar-edicao { background-color: #dc3545; color: #fff; margin-left: 10px; padding: 4px 8px; font-size: 11px; border:none; border-radius:3px; cursor:pointer;}

        /* Cards Resumo */
        .resumo-container { display: flex; justify-content: space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .resumo-card {
            background-color: #fff; border: 1px solid #e1e4e8; border-radius: 8px; padding: 15px; text-align: center;
            flex: 1; min-width: 140px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .resumo-card.alerta-vermelho { background-color: #fff5f5; border-color: #ffc9c9; }
        .resumo-card.alerta-vermelho p { color: #c92a2a; }
        .resumo-card h3 { margin: 0 0 8px; font-size: 13px; color: #666; text-transform: uppercase; }
        .resumo-card p { font-size: 28px; font-weight: bold; margin: 0; color: #003399; }

        /* Pagina√ß√£o */
        .pagination-container { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 5px; }
        .page-button { padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #fff; cursor: pointer; color: #007bff; }
        .page-button.active { background-color: #007bff; color: white; border-color: #007bff; }

        /* Calend√°rio */
        #calendar-container { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e1e4e8; }
        .fc-toolbar-title { color: #003399; }
        .fc .fc-button { background-color: #003399; border-color: #003399; }

        /* Loading e Mensagens */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #003399; border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        .loading-text { color: #333; font-size: 18px; font-weight: bold; }
        .mensagem-sucesso {
            background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px;
            margin-bottom: 20px; text-align: center; display: none; font-weight: bold;
        }
        .hidden { display: none !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- RESPONSIVIDADE (MOBILE) --- */
        @media screen and (max-width: 768px) {
            .container { padding: 15px; }
            .app-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .btn-logout { width: 100%; text-align: center; }
            .header-title h1 { font-size: 20px; }
            
            .botoes-acao { flex-direction: column; }
            .botoes-acao button { width: 100%; }
            .filtros-container { flex-direction: column; align-items: stretch; }
            .filtro-item { width: 100%; }

            /* TABELA EM MODO CARD (CART√ÉO) */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            
            tr {
                margin-bottom: 15px;
                border: 1px solid #ccc;
                border-radius: 8px;
                background: #fff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                overflow: hidden;
            }
            
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 45% !important; /* Espa√ßo para o r√≥tulo */
                text-align: right !important;
                white-space: normal;
                width: auto !important;
                min-height: 25px;
            }
            
            td:last-child { border-bottom: 0; padding-top: 10px; padding-bottom: 10px;}
            
            /* R√≥tulos via CSS (Gerados dinamicamente via data-label no JS) */
            td:before {
                position: absolute;
                top: 12px;
                left: 15px;
                width: 40%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                content: attr(data-label);
                color: #003399;
                font-size: 12px;
                text-transform: uppercase;
            }

            /* Ajustes no Calend√°rio para Mobile */
            #calendar-container { padding: 10px; }
            .fc-toolbar { flex-direction: column; gap: 10px; }
            .fc-toolbar-title { font-size: 1.2rem !important; }
        }

    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text">Carregando...</div>
    </div>

    <div id="login-container">
        <div class="login-box">
            <img src="Logo AABB 2025.png" alt="Logo AABB" class="login-logo">
            <h2>Acesso Restrito</h2>
            <p>Fa√ßa login para gerenciar</p>
            <input type="email" id="login-email" placeholder="E-mail" required>
            <input type="password" id="login-password" placeholder="Senha" required>
            <button id="btn-login" class="login-btn">Entrar</button>
            <div id="login-error">Dados incorretos.</div>
        </div>
    </div>

    <div id="app-container">
        <div class="container">
            <div class="app-header">
                <div class="header-title">
                    <h1>AABB Aracaju</h1>
                    <span>Gest√£o de Reservas</span>
                </div>
                <button id="btn-logout" class="btn-logout">Sair</button>
            </div>

            <div class="resumo-container">
                <div class="resumo-card"><h3>Total</h3><p id="total-reservas">0</p></div>
                <div class="resumo-card"><h3>Confirmadas</h3><p id="total-confirmadas">0</p></div>
                <div class="resumo-card"><h3>Canceladas</h3><p id="total-canceladas">0</p></div>
                <div id="reservas-7dias-card" class="resumo-card"><h3>Pr√≥x. 7 Dias</h3><p id="reservas-7dias">0</p></div>
            </div>

            <div id="mensagem-sucesso" class="mensagem-sucesso"></div>

            <form id="form-reserva">
                <div class="input-group"><label>Data:</label><input type="date" id="data" required></div>
                <div class="input-group"><label>Descri√ß√£o:</label><input type="text" id="descricao" placeholder="Ex: Churrasqueira" required></div>
                <div class="input-group"><label>Respons√°vel:</label><input type="text" id="responsavel" required></div>
                <div class="input-group"><label>Contato:</label><input type="text" id="contato" placeholder="(99) 99999-9999" required maxlength="15"></div>
                <div class="input-group"><label>Observa√ß√µes:</label><textarea id="observacoes" rows="2"></textarea></div>
                <div class="input-group"><label>Criado por:</label><input type="text" id="usuario" placeholder="Seu nome" required></div>
                
                <button id="btn-form-reserva" type="submit">Adicionar Reserva</button>
                <div style="text-align: right; margin-top: 5px;">
                    <button id="btn-cancelar-edicao" class="btn-cancelar-edicao" style="display:none;" type="button">Cancelar Edi√ß√£o</button>
                </div>
            </form>

            <hr>
            
            <div class="view-toggle-container">
                <button id="btn-view-lista" class="view-btn active">üìã Lista</button>
                <button id="btn-view-calendario" class="view-btn">üìÖ Calend√°rio</button>
            </div>

            <div id="section-lista">
                <div class="filtros-container">
                    <div class="filtro-item" style="flex-grow: 1;"><label>Pesquisar:</label><input type="text" id="filtro-pesquisa" placeholder="Buscar..."></div>
                    <div class="filtro-item"><label>Status:</label><select id="filtro-status"><option value="ativos">Reservados/Confirmados</option><option value="reservado">Reservados</option><option value="confirmado">Confirmados</option><option value="realizado">Realizados</option><option value="cancelado">Cancelados</option><option value="todos">Todos</option></select></div>
                    <div class="filtro-item"><label>De:</label><input type="date" id="data-inicio"></div>
                    <div class="filtro-item"><label>At√©:</label><input type="date" id="data-fim"></div>
                    <div class="filtro-item"><label>Qtd:</label><select id="qtd-por-pagina"><option value="10">10</option><option value="30" selected>30</option><option value="50">50</option><option value="all">Todos</option></select></div>
                    <div class="filtro-item"><label>&nbsp;</label><button type="button" id="btn-limpar-filtros" style="padding: 9px; cursor:pointer; border-radius:4px; border:1px solid #ccc;">Limpar</button></div>
                </div>

                <h2>Reservas Cadastradas</h2>
                
                <div id="tabela-para-pdf" class="tabela-wrapper">
                    <table id="tabela-reservas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descri√ß√£o</th>
                                <th>Respons√°vel</th>
                                <th>Contato</th>
                                <th>Observa√ß√µes</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="pagination-container" class="pagination-container"></div>
                
                <div class="botoes-acao">
                    <button id="gerar-pdf-btn" class="btn-pdf">Baixar PDF</button>
                    <button id="gerar-csv-btn" class="btn-csv">Baixar Excel</button>
                    <button id="fechar-pagina-btn" class="btn-fechar">Sair</button>
                </div>
            </div>

            <div id="section-calendario" class="hidden">
                <div id="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <div style="text-align: right; font-size: 11px; margin-top: 15px; color: #888;">
                <p id="ultimo-usuario-info"></p>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Error:', err)); }); }

        document.addEventListener('DOMContentLoaded', () => {
            // Refer√™ncias
            const loginBox = document.getElementById('login-container'), appBox = document.getElementById('app-container');
            const formReserva = document.getElementById('form-reserva'), tableBody = document.querySelector('#tabela-reservas tbody');
            const msgSucesso = document.getElementById('mensagem-sucesso'), loading = document.getElementById('loading-overlay');
            
            // Firebase
            const firebaseConfig = { apiKey: "AIzaSyDut5CV-mDqnuKV0MH8MM2ivOQMP-AF94E", authDomain: "reserva-b5ff4.firebaseapp.com", databaseURL: "https://reserva-b5ff4-default-rtdb.firebaseio.com", projectId: "reserva-b5ff4", storageBucket: "reserva-b5ff4.firebasestorage.app", messagingSenderId: "540617636797", appId: "1:540617636797:web:5081ca29f77cb9c5fab0d4" };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.database(), auth = firebase.auth(), ref = db.ref('reservas');

            // Estado
            let reservas = [], editId = null, itemsPerPage = 30, currPage = 1, calendar = null;
            const savedUser = localStorage.getItem('reserva_clube_usuario');
            if(savedUser) document.getElementById('usuario').value = savedUser;

            // Auth
            auth.onAuthStateChanged(u => {
                if (u) { loginBox.style.display = 'none'; appBox.style.display = 'block'; loadData(); }
                else { loginBox.style.display = 'flex'; appBox.style.display = 'none'; reservas = []; }
            });

            document.getElementById('btn-login').onclick = () => {
                const e = document.getElementById('login-email').value, p = document.getElementById('login-password').value;
                if(!e || !p) return alert('Preencha tudo');
                loading.classList.remove('hidden');
                auth.signInWithEmailAndPassword(e, p).catch(err => {
                    document.getElementById('login-error').style.display = 'block'; loading.classList.add('hidden');
                });
            };
            document.getElementById('btn-logout').onclick = () => { if(confirm("Sair?")) auth.signOut().then(()=>window.location.reload()); };
            
            // Carregar Dados
            function loadData() {
                ref.on('value', snap => {
                    if(reservas.length === 0) loading.classList.remove('hidden');
                    const d = snap.val();
                    reservas = d ? Object.keys(d).map(k => ({...d[k], id: k})) : [];
                    reservas.sort((a,b) => new Date(a.data) - new Date(b.data));
                    renderTable(); updateSummary(); updateLastUser();
                    if(calendar) updateCalendar();
                    loading.classList.add('hidden');
                });
            }

            // Tabela com suporte Mobile (Card View)
            function renderTable() {
                tableBody.innerHTML = '';
                const filtered = filterData();
                const pages = Math.ceil(filtered.length / itemsPerPage) || 1;
                if(currPage > pages) currPage = pages;
                const pageData = filtered.slice((currPage-1)*itemsPerPage, currPage*itemsPerPage);

                if(!pageData.length) { tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Nada encontrado.</td></tr>'; return; }

                pageData.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = r.id;
                    if(r.status==='Reservado') tr.className='reservado-row';
                    else if(r.status==='Confirmado') tr.className='confirmado-row';
                    else if(r.status==='Cancelado') tr.className='cancelado-row';
                    else if(r.status==='Realizado') tr.className='realizado-row';

                    // O atributo data-label √© o segredo para o modo Cart√£o no celular
                    tr.innerHTML = `
                        <td data-label="Data" style="text-align:center;">${fmtDate(r.data)}</td>
                        <td data-label="Descri√ß√£o"><strong>${r.descricao}</strong></td>
                        <td data-label="Respons√°vel">${r.responsavel}</td>
                        <td data-label="Contato"><a href="https://wa.me/55${r.contato.replace(/\D/g,'')}" target="_blank" style="text-decoration:none; color:#28a745; font-weight:bold;">üì± ${r.contato}</a></td>
                        <td data-label="Observa√ß√µes" style="font-size:11px; color:#555;">${r.observacoes||''}</td>
                        <td data-label="Status" style="text-align:center;"><span class="status-badge badge-${r.status.toLowerCase()}">${r.status}</span></td>
                        <td data-label="A√ß√µes" style="text-align:center;">
                            <div style="font-size:10px; color:#666; margin-bottom:4px;">Por: ${r.ultimoUsuario||'?'}</div>
                            <div style="display:flex; gap:4px; justify-content:center;">
                                <button class="btn-editar">‚úèÔ∏è</button>
                                <button class="btn-excluir">üóëÔ∏è</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                renderPag(pages);
            }

            // Calend√°rio Inteligente (Lista no Mobile, Grade no PC)
            function initCalendar() {
                const el = document.getElementById('calendar');
                // Detecta se √© celular (largura < 768px)
                const isMobile = window.innerWidth < 768;
                
                const evts = reservas.map(r => ({
                    id: r.id, title: `${r.descricao} (${r.responsavel})`, start: r.data,
                    color: r.status==='Confirmado'?'#28a745':r.status==='Reservado'?'#007bff':r.status==='Cancelado'?'#dc3545':'#6c757d',
                    extendedProps: { s: r.status }
                }));

                if(calendar) { calendar.destroy(); } // Recria para ajustar a view se girar a tela
                
                calendar = new FullCalendar.Calendar(el, {
                    initialView: isMobile ? 'listMonth' : 'dayGridMonth', // AQUI EST√Å O SEGREDINHO
                    locale: 'pt-br',
                    headerToolbar: { left: 'prev,next today', center: 'title', right: isMobile ? 'listMonth' : 'dayGridMonth,listMonth' },
                    buttonText: { today: 'Hoje', month: 'M√™s', list: 'Lista' },
                    events: evts,
                    eventClick: info => {
                        document.getElementById('btn-view-lista').click();
                        setTimeout(() => { editReserva(info.event.id); window.scrollTo({top:0, behavior:'smooth'}); }, 100);
                    }
                });
                calendar.render();
            }
            function updateCalendar() { initCalendar(); }

            // Filtros e Helpers
            function filterData() {
                const st = document.getElementById('filtro-status').value, term = document.getElementById('filtro-pesquisa').value.toLowerCase();
                const ini = document.getElementById('data-inicio').value, fim = document.getElementById('data-fim').value;
                return reservas.filter(r => {
                    const d = new Date(r.data+'T00:00:00');
                    return (st==='ativos'?(r.status==='Reservado'||r.status==='Confirmado'):st==='todos'?true:r.status.toLowerCase()===st) &&
                           (!ini || d>=new Date(ini+'T00:00:00')) && (!fim || d<=new Date(fim+'T00:00:00')) &&
                           (term==='' || r.responsavel.toLowerCase().includes(term) || r.descricao.toLowerCase().includes(term));
                });
            }
            
            // Listeners
            document.getElementById('btn-view-lista').onclick = () => { document.getElementById('section-lista').classList.remove('hidden'); document.getElementById('section-calendario').classList.add('hidden'); document.getElementById('btn-view-lista').classList.add('active'); document.getElementById('btn-view-calendario').classList.remove('active'); };
            document.getElementById('btn-view-calendario').onclick = () => { document.getElementById('section-lista').classList.add('hidden'); document.getElementById('section-calendario').classList.remove('hidden'); document.getElementById('btn-view-lista').classList.remove('active'); document.getElementById('btn-view-calendario').classList.add('active'); setTimeout(initCalendar, 100); };
            
            // Submit Form
            formReserva.addEventListener('submit', e => {
                e.preventDefault();
                const d = { data: document.getElementById('data').value, descricao: document.getElementById('descricao').value, responsavel: document.getElementById('responsavel').value, contato: document.getElementById('contato').value, observacoes: document.getElementById('observacoes').value, ultimoUsuario: document.getElementById('usuario').value };
                
                // Valida conflito
                const conflito = reservas.some(r => r.data === d.data && r.descricao.toLowerCase() === d.descricao.toLowerCase() && r.status === 'Confirmado' && (!editId || r.id !== editId));
                if(conflito) return alert('J√° existe reserva confirmada neste local/data.');

                localStorage.setItem('reserva_clube_usuario', d.ultimoUsuario);
                loading.classList.remove('hidden');
                
                if(editId) {
                    ref.child(editId).update(d).then(() => { showMsg('Atualizado!'); resetForm(); }).finally(() => loading.classList.add('hidden'));
                } else {
                    d.status = 'Reservado';
                    ref.push(d).then(() => { showMsg('Criado!'); resetForm(); }).finally(() => loading.classList.add('hidden'));
                }
            });

            // A√ß√µes Tabela
            tableBody.addEventListener('click', e => {
                const tr = e.target.closest('tr'); if(!tr) return;
                const id = tr.dataset.id;
                if(e.target.classList.contains('btn-editar')) editReserva(id);
                if(e.target.classList.contains('btn-excluir') && confirm('Excluir?')) ref.child(id).remove();
                if(e.target.classList.contains('status-badge')) changeStatus(id, e.target.closest('td'));
            });

            // Formata√ß√£o e Utils
            document.getElementById('contato').addEventListener('input', e => { e.target.value = e.target.value.replace(/\D/g,'').replace(/^(\d{2})(\d)/g,"($1) $2").replace(/(\d)(\d{4})$/,"$1-$2"); });
            document.getElementById('filtro-status').onchange = renderTable;
            document.getElementById('filtro-pesquisa').oninput = renderTable;
            document.getElementById('qtd-por-pagina').onchange = (e) => { itemsPerPage = e.target.value==='all'?9999:parseInt(e.target.value); renderTable(); };
            
            // PDF
            document.getElementById('gerar-pdf-btn').onclick = () => {
                if(!document.getElementById('section-calendario').classList.contains('hidden')) return alert('V√° para Lista');
                const t = document.getElementById('tabela-para-pdf'), old = t.innerHTML;
                // Hack para PDF: remove inputs de a√ß√µes temporariamente
                const rows = t.querySelectorAll('tr'); 
                rows.forEach(r => { 
                   if(r.cells.length > 0) {
                       r.cells[6].style.display='none'; // Esconde A√ß√µes
                       // For√ßa estilo para PDF (remove display block do mobile)
                       r.style.display = 'table-row';
                       Array.from(r.cells).forEach(c => { c.style.display='table-cell'; c.style.border='1px solid #ccc'; });
                   }
                });
                const th = t.querySelector('thead tr');
                th.cells[6].style.display='none';

                html2pdf().set({ margin:5, filename:'relatorio.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'landscape'} }).from(t).save()
                .then(() => renderTable()); // Restaura tabela
            };

            function fmtDate(d) { if(!d) return '-'; const p = d.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
            function editReserva(id) {
                const r = reservas.find(x => x.id === id); if(!r) return;
                editId = id; document.getElementById('data').value=r.data; document.getElementById('descricao').value=r.descricao;
                document.getElementById('responsavel').value=r.responsavel; document.getElementById('contato').value=r.contato;
                document.getElementById('observacoes').value=r.observacoes||'';
                document.getElementById('btn-form-reserva').textContent='Salvar'; document.getElementById('btn-cancelar-edicao').style.display='inline-block';
                document.getElementById('btn-form-reserva').style.background='#ffc107'; document.getElementById('btn-form-reserva').style.color='#000';
            }
            function resetForm() {
                const u = document.getElementById('usuario').value; formReserva.reset(); document.getElementById('usuario').value=u;
                editId=null; document.getElementById('btn-form-reserva').textContent='Adicionar Reserva'; 
                document.getElementById('btn-form-reserva').style.background='#28a745'; document.getElementById('btn-form-reserva').style.color='#fff';
                document.getElementById('btn-cancelar-edicao').style.display='none';
            }
            function showMsg(m) { msgSucesso.textContent=m; msgSucesso.style.display='block'; setTimeout(()=>msgSucesso.style.display='none',3000); }
            function changeStatus(id, cell) {
                if(cell.querySelector('select')) return;
                const r = reservas.find(x => x.id===id);
                cell.innerHTML=`<select><option value="Reservado">Reservado</option><option value="Confirmado">Confirmado</option><option value="Cancelado">Cancelado</option><option value="Realizado">Realizado</option></select>`;
                const s = cell.querySelector('select'); s.value=r.status; s.focus();
                s.onblur = () => { if(s.value!==r.status) ref.child(id).update({status:s.value}); renderTable(); };
            }
            function renderPag(tot) {
                const c = document.getElementById('pagination-container'); c.innerHTML='';
                const b = (t,p) => { const btn=document.createElement('button'); btn.textContent=t; btn.className=`page-button ${p===currPage?'active':''}`; btn.onclick=()=>{currPage=p; renderTable();}; c.appendChild(btn); };
                for(let i=1; i<=tot; i++) b(i,i);
            }
            function updateSummary() {
                const tot = reservas.length;
                const conf = reservas.filter(r=>r.status==='Confirmado').length;
                const canc = reservas.filter(r=>r.status==='Cancelado').length;
                const h = new Date(); h.setHours(0,0,0,0); const lim = new Date(); lim.setDate(h.getDate()+7);
                const prox = reservas.filter(r => { const d=new Date(r.data+'T00:00:00'); return d>=h && d<=lim && r.status!=='Cancelado'; }).length;
                document.getElementById('total-reservas').textContent=tot; document.getElementById('total-confirmadas').textContent=conf;
                document.getElementById('total-canceladas').textContent=canc; document.getElementById('reservas-7dias').textContent=prox;
                if(prox>0) document.getElementById('reservas-7dias-card').classList.add('alerta-vermelho'); else document.getElementById('reservas-7dias-card').classList.remove('alerta-vermelho');
            }
            function updateLastUser() {
                ref.orderByKey().limitToLast(1).once('value', s => { const d=s.val(); if(d) { const k=Object.keys(d)[0]; document.getElementById('ultimo-usuario-info').textContent=`√öltimo registro: ${d[k].ultimoUsuario} (${fmtDate(d[k].data)})`; }});
            }
        });
    </script>
</body>
</html>