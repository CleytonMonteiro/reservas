<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Reservas do Clube</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 25px 35px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }

        hr {
            border: 0;
            border-top: 1px solid #e1e4e8;
            margin: 25px 0;
        }

        /* --- Formul√°rio --- */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus, .input-group textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        
        #btn-form-reserva {
            width: 100%;
            padding: 12px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s;
        }

        #btn-form-reserva:hover {
            background-color: #218838;
        }
        
        #btn-form-reserva:disabled {
            background-color: #94d3a2;
            cursor: not-allowed;
        }

        /* --- Filtros --- */
        .filtros-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .filtro-item {
            display: flex;
            flex-direction: column;
        }

        /* Estiliza√ß√£o espec√≠fica para inputs dentro dos filtros */
        .filtro-item input, 
        .filtro-item select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* --- Tabela --- */
        .tabela-wrapper {
            overflow-x: auto;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            table-layout: fixed;
            background: white;
        }

        table, th, td {
            border: 1px solid #dee2e6;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            word-wrap: break-word;
        }
        
        th {
            background-color: #f1f3f5;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
        }

        th:nth-child(1), td:nth-child(1) { width: 90px; }  /* Data */
        th:nth-child(2), td:nth-child(2) { width: 18%; } /* Descri√ß√£o */
        th:nth-child(3), td:nth-child(3) { width: 15%; } /* Respons√°vel */
        th:nth-child(4), td:nth-child(4) { width: 110px; } /* Contato */
        th:nth-child(5), td:nth-child(5) { width: 25%; } /* Observa√ß√µes */
        th:nth-child(6), td:nth-child(6) { width: 100px; text-align: center;} /* Status */
        th:nth-child(7), td:nth-child(7) { width: 100px; text-align: center;} /* A√ß√µes */

        .confirmado-row { background-color: #d4edda; }
        .reservado-row { background-color: #fff3cd; }
        .cancelado-row { background-color: #f8d7da; }
        .realizado-row { background-color: #e2e3e5; }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.1);
        }
        .badge-reservado { background-color: #007bff; }
        .badge-confirmado { background-color: #28a745; }
        .badge-cancelado { background-color: #dc3545; }
        .badge-realizado { background-color: #6c757d; }
        
        /* --- Bot√µes de A√ß√£o --- */
        .botoes-acao {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }

        .botoes-acao button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-weight: bold;
        }

        .btn-pdf { background-color: #17a2b8; }
        .btn-pdf:hover { background-color: #138496; }

        .btn-csv { background-color: #218838; }
        .btn-csv:hover { background-color: #1e7e34; }

        .btn-fechar { background-color: #6c757d; }
        .btn-fechar:hover { background-color: #5a6268; }

        .mensagem-sucesso {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            font-weight: bold;
        }
        
        .btn-editar, .btn-cancelar-edicao, .btn-excluir {
            padding: 4px 8px;
            border: none;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            margin: 2px;
        }

        .btn-editar { background-color: #ffc107; color: #000; }
        .btn-excluir { background-color: #dc3545; color: #fff; }
        .btn-cancelar-edicao { background-color: #dc3545; color: #fff; margin-left: 10px; }

        /* --- Cards de Resumo --- */
        .resumo-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .resumo-card {
            background-color: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            flex: 1;
            min-width: 140px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .resumo-card.alerta-vermelho {
            background-color: #fff5f5;
            border-color: #ffc9c9;
            color: #c92a2a;
        }

        .resumo-card h3 {
            margin: 0 0 8px;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .resumo-card p {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
            color: #2c3e50;
        }

        .resumo-card.alerta-vermelho p { color: #c92a2a; }

        /* --- Pagina√ß√£o --- */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 5px;
            user-select: none;
        }

        .page-button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            color: #007bff;
        }

        .page-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .page-button.disabled {
            cursor: not-allowed;
            opacity: 0.5;
            color: #6c757d;
        }

        /* --- LOADING OVERLAY --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: #333;
            font-size: 18px;
            font-weight: bold;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Carregando dados...</div>
    </div>

    <div class="container">
        <h1>Cadastro de Reservas</h1>

        <div class="resumo-container">
            <div class="resumo-card">
                <h3>Total</h3>
                <p id="total-reservas">0</p>
            </div>
            <div class="resumo-card">
                <h3>Confirmadas</h3>
                <p id="total-confirmadas">0</p>
            </div>
            <div class="resumo-card">
                <h3>Canceladas</h3>
                <p id="total-canceladas">0</p>
            </div>
            <div id="reservas-7dias-card" class="resumo-card">
                <h3>Pr√≥ximos 7 Dias</h3>
                <p id="reservas-7dias">0</p>
            </div>
        </div>

        <div id="mensagem-sucesso" class="mensagem-sucesso"></div>

        <form id="form-reserva">
            <div class="input-group">
                <label for="data">Data:</label>
                <input type="date" id="data" required>
            </div>
            <div class="input-group">
                <label for="descricao">Descri√ß√£o (Local/Evento):</label>
                <input type="text" id="descricao" placeholder="Ex: Churrasqueira, Sal√£o de Festas, Anivers√°rio" required>
            </div>
            <div class="input-group">
                <label for="responsavel">Nome do Respons√°vel:</label>
                <input type="text" id="responsavel" required>
            </div>
            <div class="input-group">
                <label for="contato">WhatsApp / Contato:</label>
                <input type="text" id="contato" placeholder="(99) 99999-9999" required maxlength="15">
            </div>
            <div class="input-group">
                <label for="observacoes">Observa√ß√µes:</label>
                <textarea id="observacoes" placeholder="Adicione notas, hor√°rio espec√≠fico, ou detalhes extras" rows="2"></textarea>
            </div>
            <div class="input-group">
                <label for="usuario">Quem est√° registrando (Funcion√°rio):</label>
                <input type="text" id="usuario" placeholder="Seu nome" required>
            </div>
            
            <button id="btn-form-reserva" type="submit">Adicionar Reserva</button>
            <div style="text-align: right; margin-top: 5px;">
                <button id="btn-cancelar-edicao" class="btn-cancelar-edicao" style="display:none;" type="button">Cancelar Edi√ß√£o</button>
            </div>
        </form>

        <hr>

        <div class="filtros-container">
            <div class="filtro-item" style="flex-grow: 1;">
                <label for="filtro-pesquisa">Pesquisar:</label>
                <input type="text" id="filtro-pesquisa" placeholder="Nome, descri√ß√£o ou observa√ß√£o...">
            </div>
            <div class="filtro-item">
                <label for="filtro-status">Status:</label>
                <select id="filtro-status">
                    <option value="ativos">Reservados e Confirmados</option>
                    <option value="reservado">Apenas Reservados</option>
                    <option value="confirmado">Apenas Confirmados</option>
                    <option value="realizado">Realizados</option>
                    <option value="cancelado">Cancelados</option>
                    <option value="todos">Todos os Registros</option>
                </select>
            </div>
            <div class="filtro-item">
                <label for="data-inicio">De:</label>
                <input type="date" id="data-inicio">
            </div>
            <div class="filtro-item">
                <label for="data-fim">At√©:</label>
                <input type="date" id="data-fim">
            </div>
            <div class="filtro-item">
                <label for="qtd-por-pagina">Exibir por p√°g:</label>
                <select id="qtd-por-pagina">
                    <option value="10">10</option>
                    <option value="30" selected>30</option>
                    <option value="50">50</option>
                    <option value="all">Todos</option>
                </select>
            </div>
            <div class="filtro-item">
                 <label>&nbsp;</label>
                 <button type="button" id="btn-limpar-filtros" style="padding: 9px; cursor:pointer; border-radius:4px; border:1px solid #ccc;">Limpar</button>
            </div>
        </div>

        <h2>Reservas Cadastradas</h2>
        
        <div id="tabela-para-pdf" class="tabela-wrapper">
            <table id="tabela-reservas">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Respons√°vel</th>
                        <th>Contato</th>
                        <th>Observa√ß√µes</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div id="pagination-container" class="pagination-container"></div>
        
        <div class="botoes-acao">
            <button id="gerar-pdf-btn" class="btn-pdf">Baixar PDF</button>
            <button id="gerar-csv-btn" class="btn-csv">Baixar Excel (CSV)</button>
            <button id="fechar-pagina-btn" class="btn-fechar">Sair</button>
        </div>
        <div style="text-align: right; font-size: 11px; margin-top: 15px; color: #888;">
            <p id="ultimo-usuario-info"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos DOM
            const formReserva = document.getElementById('form-reserva');
            const tabelaReservasBody = document.querySelector('#tabela-reservas tbody');
            
            // Elementos de Filtro
            const filtroStatusSelect = document.getElementById('filtro-status');
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            const filtroPesquisaInput = document.getElementById('filtro-pesquisa'); 
            const qtdPorPaginaSelect = document.getElementById('qtd-por-pagina'); // Novo
            const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
            
            const gerarPdfBtn = document.getElementById('gerar-pdf-btn');
            const gerarCsvBtn = document.getElementById('gerar-csv-btn');
            const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');
            
            const mensagemSucesso = document.getElementById('mensagem-sucesso');
            const btnFormReserva = document.getElementById('btn-form-reserva');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');
            
            const contatoInput = document.getElementById('contato');
            const usuarioInput = document.getElementById('usuario');
            const observacoesInput = document.getElementById('observacoes');
            const ultimoUsuarioInfo = document.getElementById('ultimo-usuario-info');
            const loadingOverlay = document.getElementById('loading-overlay');

            // Cards e Pagina√ß√£o
            const totalReservasElement = document.getElementById('total-reservas');
            const totalConfirmadasElement = document.getElementById('total-confirmadas');
            const totalCanceladasElement = document.getElementById('total-canceladas');
            const reservas7diasElement = document.getElementById('reservas-7dias');
            const reservas7diasCard = document.getElementById('reservas-7dias-card');
            const paginationContainer = document.getElementById('pagination-container');

            // Vari√°veis de Controle
            let reservaParaEditar = null;
            let itemsPerPage = 30; // Padr√£o inicial alterado para 30
            let currentPage = 1;
            let reservas = [];

            // --- Carregar Usu√°rio do LocalStorage ---
            const usuarioSalvo = localStorage.getItem('reserva_clube_usuario');
            if (usuarioSalvo) {
                usuarioInput.value = usuarioSalvo;
            }

            // Configura√ß√£o Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDut5CV-mDqnuKV0MH8MM2ivOQMP-AF94E",
                authDomain: "reserva-b5ff4.firebaseapp.com",
                databaseURL: "https://reserva-b5ff4-default-rtdb.firebaseio.com",
                projectId: "reserva-b5ff4",
                storageBucket: "reserva-b5ff4.firebasestorage.app",
                messagingSenderId: "540617636797",
                appId: "1:540617636797:web:5081ca29f77cb9c5fab0d4"
            };

            // Inicializa√ß√£o Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const database = firebase.database();
            const reservasRef = database.ref('reservas');
            
            // --- Fun√ß√£o de Loading ---
            function toggleLoading(show) {
                if (show) {
                    loadingOverlay.classList.remove('hidden');
                } else {
                    loadingOverlay.classList.add('hidden');
                }
            }

            // Carregamento de Dados
            reservasRef.on('value', (snapshot) => {
                toggleLoading(true);
                try {
                    const data = snapshot.val();
                    reservas = [];
                    if (data) {
                        for (let key in data) {
                            reservas.push({ ...data[key], id: key });
                        }
                    }
                    ordenarReservas();
                    renderizarTabela();
                    atualizarUltimoUsuarioNaPagina();
                    atualizarResumo();
                } catch (error) {
                    console.error("Erro ao processar dados:", error);
                    alert("Erro ao carregar dados. Verifique sua conex√£o.");
                } finally {
                    toggleLoading(false);
                }
            });

            // Submit do Formul√°rio
            formReserva.addEventListener('submit', (e) => {
                e.preventDefault();

                if (!contatoInput.value) {
                    alert('O campo Contato √© obrigat√≥rio.');
                    return;
                }
                if (!usuarioInput.value) {
                    alert('O campo Quem fez a reserva √© obrigat√≥rio.');
                    return;
                }

                const dataInput = document.getElementById('data');
                const descricaoInput = document.getElementById('descricao');
                
                // Valida√ß√£o de Data Passada
                const dataSelecionada = new Date(dataInput.value + 'T00:00:00');
                const dataAtual = new Date();
                dataAtual.setHours(0, 0, 0, 0);

                if (dataSelecionada < dataAtual && !reservaParaEditar) {
                     if(!confirm("Aten√ß√£o: Voc√™ est√° agendando para uma data que j√° passou. Deseja continuar?")) {
                         return;
                     }
                }

                // Verifica√ß√£o de Conflito
                const conflitoExistente = reservas.some(reserva => 
                    reserva.data === dataInput.value &&
                    reserva.descricao.toLowerCase() === descricaoInput.value.toLowerCase() &&
                    reserva.status === 'Confirmado' &&
                    (!reservaParaEditar || reserva.id !== reservaParaEditar.id)
                );

                if (conflitoExistente) {
                    alert('J√° existe uma reserva CONFIRMADA para esta data e descri√ß√£o. Verifique antes de salvar.');
                    return;
                }

                localStorage.setItem('reserva_clube_usuario', usuarioInput.value);

                const dadosReserva = {
                    data: dataInput.value,
                    descricao: descricaoInput.value,
                    responsavel: document.getElementById('responsavel').value,
                    contato: contatoInput.value,
                    observacoes: observacoesInput.value,
                    ultimoUsuario: usuarioInput.value
                };
                
                btnFormReserva.disabled = true;
                toggleLoading(true);

                if (reservaParaEditar) {
                    dadosReserva.status = reservaParaEditar.status; 
                    
                    reservasRef.child(reservaParaEditar.id).update(dadosReserva)
                        .then(() => {
                            mostrarMensagemSucesso("Reserva atualizada com sucesso!");
                            resetarFormulario();
                        })
                        .catch(error => {
                            console.error("Erro", error);
                            alert("Erro ao atualizar.");
                        })
                        .finally(() => {
                            btnFormReserva.disabled = false;
                            toggleLoading(false);
                        });

                } else {
                    dadosReserva.status = 'Reservado';
                    reservasRef.push(dadosReserva)
                        .then(() => {
                            mostrarMensagemSucesso("Nova reserva criada!");
                            const userTemp = usuarioInput.value;
                            formReserva.reset();
                            usuarioInput.value = userTemp;
                        })
                        .catch(error => {
                            console.error("Erro", error);
                            alert("Erro ao criar reserva.");
                        })
                        .finally(() => {
                            btnFormReserva.disabled = false;
                            toggleLoading(false);
                        });
                }
            });

            // Formata√ß√£o Telefone
            contatoInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';
                if (value.length > 0) formattedValue = '(' + value.substring(0, 2);
                if (value.length >= 3) formattedValue += ') ' + value.substring(2, 7);
                if (value.length >= 8) formattedValue += '-' + value.substring(7, 11);
                e.target.value = formattedValue;
            });

            // Listeners de Filtro
            filtroStatusSelect.addEventListener('change', () => { currentPage = 1; renderizarTabela(); });
            dataInicioInput.addEventListener('change', () => { currentPage = 1; renderizarTabela(); });
            dataFimInput.addEventListener('change', () => { currentPage = 1; renderizarTabela(); });
            filtroPesquisaInput.addEventListener('input', () => { currentPage = 1; renderizarTabela(); });
            
            // --- Listener do NOVO Seletor de Quantidade ---
            qtdPorPaginaSelect.addEventListener('change', (e) => {
                const valor = e.target.value;
                if (valor === 'all') {
                    itemsPerPage = 99999; // N√∫mero alto para exibir todos
                } else {
                    itemsPerPage = parseInt(valor);
                }
                currentPage = 1; // Volta para a primeira p√°gina
                renderizarTabela();
            });
            
            btnLimparFiltros.addEventListener('click', () => {
                filtroStatusSelect.value = 'ativos';
                dataInicioInput.value = '';
                dataFimInput.value = '';
                filtroPesquisaInput.value = '';
                qtdPorPaginaSelect.value = '30'; // Reseta para o padr√£o
                itemsPerPage = 30;
                currentPage = 1;
                renderizarTabela();
            });

            // Gera√ß√£o de PDF
            gerarPdfBtn.addEventListener('click', () => {
                const tabelaParaPdf = document.getElementById('tabela-para-pdf');
                
                const linhas = document.querySelectorAll('#tabela-reservas tbody tr');
                const thAcoes = document.querySelector('th:last-child');
                const tdAcoes = document.querySelectorAll('td:last-child');
                
                thAcoes.style.display = 'none';
                tdAcoes.forEach(td => td.style.display = 'none');

                linhas.forEach(linha => {
                    const cor = window.getComputedStyle(linha).backgroundColor;
                    linha.style.backgroundColor = cor;
                });

                const opt = {
                    margin: 5,
                    filename: 'relatorio_reservas.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };

                html2pdf().set(opt).from(tabelaParaPdf).save().then(() => {
                    thAcoes.style.display = '';
                    tdAcoes.forEach(td => td.style.display = '');
                    linhas.forEach(linha => linha.style.backgroundColor = '');
                });
            });

            // Gera√ß√£o de CSV
            gerarCsvBtn.addEventListener('click', () => {
                const dadosTabela = [];
                const BOM = "\uFEFF"; 
                const cabecalho = ['Data', 'Descricao', 'Responsavel', 'Contato', 'Observacoes', 'Status', 'Criador'];
                dadosTabela.push(cabecalho.join(';'));
                
                const reservasParaExportar = filtrarReservas();
                
                reservasParaExportar.forEach(reserva => {
                    const linha = [
                        formatarData(reserva.data),
                        `"${reserva.descricao}"`,
                        `"${reserva.responsavel}"`,
                        reserva.contato,
                        `"${(reserva.observacoes || '').replace(/(\r\n|\n|\r)/gm, " ")}"`,
                        reserva.status,
                        reserva.ultimoUsuario
                    ];
                    dadosTabela.push(linha.join(';'));
                });

                const csvContent = "data:text/csv;charset=utf-8," + BOM + dadosTabela.join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "reservas_clube.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            fecharPaginaBtn.addEventListener('click', () => window.close());
            
            // A√ß√µes na Tabela
            tabelaReservasBody.addEventListener('click', (e) => {
                const target = e.target;
                const tr = target.closest('tr');
                if (!tr) return;
                const idReserva = tr.dataset.id;

                if (target.classList.contains('btn-editar')) {
                    editarReserva(idReserva);
                }
                else if (target.classList.contains('btn-excluir')) {
                    if (confirm("ATEN√á√ÉO: Deseja realmente excluir permanentemente esta reserva?")) {
                        toggleLoading(true);
                        reservasRef.child(idReserva).remove()
                            .then(() => mostrarMensagemSucesso("Exclu√≠do com sucesso!"))
                            .catch(err => alert('Erro ao excluir: ' + err.message))
                            .finally(() => toggleLoading(false));
                    }
                }
                else if (target.classList.contains('status-badge')) {
                    const cell = target.closest('td');
                    abrirOpcoesStatus(idReserva, cell);
                }
            });

            btnCancelarEdicao.addEventListener('click', resetarFormulario);

            // Fun√ß√µes Auxiliares
            function formatarData(dataString) {
                if (!dataString) return '-';
                const [ano, mes, dia] = dataString.split('-');
                return `${dia}/${mes}/${ano}`;
            }

            function editarReserva(id) {
                reservaParaEditar = reservas.find(res => res.id === id);
                if (reservaParaEditar) {
                    document.getElementById('data').value = reservaParaEditar.data;
                    document.getElementById('descricao').value = reservaParaEditar.descricao;
                    document.getElementById('responsavel').value = reservaParaEditar.responsavel;
                    document.getElementById('contato').value = reservaParaEditar.contato;
                    document.getElementById('observacoes').value = reservaParaEditar.observacoes || '';
                    document.getElementById('usuario').value = reservaParaEditar.ultimoUsuario || usuarioInput.value;
                    
                    btnFormReserva.textContent = "Salvar Altera√ß√µes";
                    btnFormReserva.style.backgroundColor = "#ffc107";
                    btnFormReserva.style.color = "#000";
                    btnCancelarEdicao.style.display = "inline-block";
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            function resetarFormulario() {
                const userSaved = usuarioInput.value;
                formReserva.reset();
                usuarioInput.value = userSaved;
                
                btnFormReserva.textContent = "Adicionar Reserva";
                btnFormReserva.style.backgroundColor = "#28a745";
                btnFormReserva.style.color = "#fff";
                btnCancelarEdicao.style.display = "none";
                reservaParaEditar = null;
            }

            function mostrarMensagemSucesso(mensagem) {
                mensagemSucesso.textContent = mensagem;
                mensagemSucesso.style.display = 'block';
                setTimeout(() => {
                    mensagemSucesso.style.display = 'none';
                }, 3000);
            }

            function ordenarReservas() {
                reservas.sort((a, b) => new Date(a.data) - new Date(b.data));
            }

            function atualizarResumo() {
                const total = reservas.length;
                const confirmadas = reservas.filter(res => res.status === 'Confirmado').length;
                const canceladas = reservas.filter(res => res.status === 'Cancelado').length;

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const dataLimite7Dias = new Date();
                dataLimite7Dias.setDate(hoje.getDate() + 7);

                const proximos7Dias = reservas.filter(res => {
                    const dataReserva = new Date(res.data + 'T00:00:00');
                    const statusAtivo = res.status === 'Reservado' || res.status === 'Confirmado';
                    return dataReserva >= hoje && dataReserva <= dataLimite7Dias && statusAtivo;
                }).length;

                totalReservasElement.textContent = total;
                totalConfirmadasElement.textContent = confirmadas;
                totalCanceladasElement.textContent = canceladas;
                reservas7diasElement.textContent = proximos7Dias;

                if (proximos7Dias > 0) {
                    reservas7diasCard.classList.add('alerta-vermelho');
                } else {
                    reservas7diasCard.classList.remove('alerta-vermelho');
                }
            }

            function filtrarReservas() {
                const filtroStatus = filtroStatusSelect.value;
                const dataInicio = dataInicioInput.value;
                const dataFim = dataFimInput.value;
                const termoPesquisa = filtroPesquisaInput.value.toLowerCase();
                
                return reservas.filter(reserva => {
                    let statusValido = false;
                    if (filtroStatus === 'ativos') {
                        statusValido = reserva.status === 'Reservado' || reserva.status === 'Confirmado';
                    } else if (filtroStatus === 'todos') { 
                        statusValido = true;
                    } else {
                        statusValido = reserva.status.toLowerCase() === filtroStatus;
                    }
                    
                    const dataReserva = new Date(reserva.data + 'T00:00:00');
                    const dataInicioValida = !dataInicio || dataReserva >= new Date(dataInicio + 'T00:00:00');
                    const dataFimValida = !dataFim || dataReserva <= new Date(dataFim + 'T00:00:00');
                    
                    const pesquisaValida = termoPesquisa === '' ||
                        reserva.responsavel.toLowerCase().includes(termoPesquisa) ||
                        reserva.descricao.toLowerCase().includes(termoPesquisa) ||
                        (reserva.ultimoUsuario && reserva.ultimoUsuario.toLowerCase().includes(termoPesquisa)) ||
                        (reserva.observacoes && reserva.observacoes.toLowerCase().includes(termoPesquisa));

                    return statusValido && dataInicioValida && dataFimValida && pesquisaValida;
                });
            }

            function renderizarTabela() {
                tabelaReservasBody.innerHTML = '';
                
                const reservasFiltradas = filtrarReservas();
                const totalPaginas = Math.ceil(reservasFiltradas.length / itemsPerPage) || 1;
                
                if (currentPage > totalPaginas) currentPage = totalPaginas;

                const inicio = (currentPage - 1) * itemsPerPage;
                const fim = inicio + itemsPerPage;
                const reservasPaginadas = reservasFiltradas.slice(inicio, fim);
                
                if (reservasPaginadas.length === 0) {
                    tabelaReservasBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Nenhuma reserva encontrada.</td></tr>';
                }

                reservasPaginadas.forEach(reserva => {
                    const novaLinha = document.createElement('tr');
                    novaLinha.dataset.id = reserva.id;
                    
                    let rowClass = '';
                    if (reserva.status === 'Reservado') rowClass = 'reservado-row';
                    else if (reserva.status === 'Confirmado') rowClass = 'confirmado-row';
                    else if (reserva.status === 'Cancelado') rowClass = 'cancelado-row';
                    else if (reserva.status === 'Realizado') rowClass = 'realizado-row';
                    
                    if(rowClass) novaLinha.classList.add(rowClass);
                    
                    const numeroLimpo = reserva.contato.replace(/\D/g, '');

                    novaLinha.innerHTML = `
                        <td style="text-align:center;">${formatarData(reserva.data)}</td>
                        <td><strong>${reserva.descricao}</strong></td>
                        <td>${reserva.responsavel}</td>
                        <td>
                            <a href="https://wa.me/55${numeroLimpo}" target="_blank" style="text-decoration:none; color: #28a745; font-weight:bold;">
                                üì± ${reserva.contato}
                            </a>
                        </td>
                        <td style="font-size: 11px; color: #555;">${reserva.observacoes || ''}</td>
                        <td style="text-align:center;">
                            <span class="status-badge badge-${reserva.status.toLowerCase()}">${reserva.status}</span>
                        </td>
                        <td style="text-align:center;">
                            <div style="font-size:10px; color:#666; margin-bottom:4px;">Por: ${reserva.ultimoUsuario || '?'}</div>
                            <div style="display: flex; gap: 4px; justify-content: center;">
                                <button class="btn-editar" title="Editar">‚úèÔ∏è</button>
                                <button class="btn-excluir" title="Excluir">üóëÔ∏è</button>
                            </div>
                        </td>
                    `;
                    
                    tabelaReservasBody.appendChild(novaLinha);
                });
                
                renderizarPaginacao(totalPaginas);
            }

            function renderizarPaginacao(totalPaginas) {
                paginationContainer.innerHTML = '';
                
                const createBtn = (text, page, active = false, disabled = false) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.classList.add('page-button');
                    if (active) btn.classList.add('active');
                    if (disabled) btn.classList.add('disabled');
                    if (!disabled) btn.onclick = () => { currentPage = page; renderizarTabela(); };
                    return btn;
                };

                paginationContainer.appendChild(createBtn('¬´', currentPage - 1, false, currentPage === 1));

                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPaginas, currentPage + 2);

                for (let i = startPage; i <= endPage; i++) {
                    paginationContainer.appendChild(createBtn(i, i, i === currentPage));
                }
                
                paginationContainer.appendChild(createBtn('¬ª', currentPage + 1, false, currentPage >= totalPaginas));
            }
            
            function abrirOpcoesStatus(id, cell) {
                const reserva = reservas.find(res => res.id === id);
                if (!reserva) return;
                
                if(cell.querySelector('select')) return;

                const statusAtual = reserva.status;
                
                cell.innerHTML = `
                    <select class="status-select-temp" style="padding:5px; border-radius:4px;">
                        <option value="Reservado">Reservado</option>
                        <option value="Confirmado">Confirmado</option>
                        <option value="Cancelado">Cancelado</option>
                        <option value="Realizado">Realizado</option>
                    </select>
                `;
                
                const select = cell.querySelector('select');
                select.value = statusAtual;
                select.focus();
                
                const salvarStatus = () => {
                    const novoStatus = select.value;
                    if (novoStatus !== statusAtual) {
                        toggleLoading(true);
                        reservasRef.child(reserva.id).update({ status: novoStatus })
                            .then(() => mostrarMensagemSucesso("Status atualizado!"))
                            .catch(error => console.error(error))
                            .finally(() => toggleLoading(false));
                    } else {
                        renderizarTabela();
                    }
                };

                select.addEventListener('blur', salvarStatus);
                select.addEventListener('change', () => select.blur());
            }
            
            function atualizarUltimoUsuarioNaPagina() {
                reservasRef.orderByKey().limitToLast(1).once('value', (snapshot) => {
                    const ultimoRegistro = snapshot.val();
                    if (ultimoRegistro) {
                        const ultimoId = Object.keys(ultimoRegistro)[0];
                        const dados = ultimoRegistro[ultimoId];
                        if (dados.ultimoUsuario) {
                            ultimoUsuarioInfo.textContent = `√öltimo registro no sistema por: ${dados.ultimoUsuario} em ${formatarData(dados.data)}`;
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>