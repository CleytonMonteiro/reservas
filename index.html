<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Reservas do Clube</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            text-align: center;
            color: #333;
        }

        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #btn-form-reserva {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        #btn-form-reserva:hover {
            background-color: #218838;
        }

        .filtros-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filtro-item {
            margin-bottom: 10px;
        }
        
        .tabela-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            table-layout: fixed;
        }

        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            word-wrap: break-word;
        }
        
        th {
            background-color: #f2f2f2;
            color: #333;
        }

        th:nth-child(1), td:nth-child(1) { width: 7%; }  /* Data */
        th:nth-child(2), td:nth-child(2) { width: 18%; } /* Descrição */
        th:nth-child(3), td:nth-child(3) { width: 15%; } /* Responsável */
        th:nth-child(4), td:nth-child(4) { width: 10%; } /* Contato */
        th:nth-child(5), td:nth-child(5) { width: 28%; } /* Observações */
        th:nth-child(6), td:nth-child(6) { width: 10%; } /* Status */
        th:nth-child(7), td:nth-child(7) { width: 12%; } /* Criador / Ações */


        /* Classes de cores para as linhas da tabela */
        .confirmado-row { background-color: #d4edda; }
        .reservado-row { background-color: #fff3cd; }
        .cancelado-row { background-color: #e9ecef; }
        .realizado-row { background-color: #e2e3e5; } /* NOVO */
        
        /* NOVO: Estilos para o novo "rótulo" de status */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            text-align: center;
            min-width: 80px;
            box-sizing: border-box;
            user-select: none;
        }
        .badge-reservado { background-color: #007bff; }
        .badge-confirmado { background-color: #28a745; }
        .badge-cancelado { background-color: #dc3545; }
        .badge-realizado { background-color: #6c757d; } /* NOVO */
        
        .botoes-acao {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .botoes-acao button {
            width: 100%;
            margin-top: 0;
        }

        .btn-pdf {
            background-color: #007bff;
        }

        .btn-pdf:hover {
            background-color: #0056b3;
        }

        .btn-fechar {
            background-color: #6c757d;
        }

        .btn-fechar:hover {
            background-color: #5a6268;
        }

        .mensagem-sucesso {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .btn-editar, .btn-cancelar-edicao, .btn-excluir {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }

        .btn-editar {
            background-color: #ffc107;
            color: #000;
        }
        .btn-excluir {
            background-color: #dc3545;
            color: #fff;
        }

        .btn-cancelar-edicao {
            background-color: #dc3545;
            color: #fff;
            margin-left: 10px;
        }

        .btn-csv {
            background-color: #1a7c36;
            color: #fff;
        }

        .resumo-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .resumo-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            flex: 1;
            margin: 5px;
            min-width: 150px;
        }
        
        .resumo-card.alerta-vermelho {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.4);
            font-size: 1.1em;
        }

        .resumo-card h3 {
            margin: 0 0 5px;
            font-size: 14px;
            color: #666;
        }

        .resumo-card.alerta-vermelho h3,
        .resumo-card.alerta-vermelho p {
            color: #721c24;
        }

        .resumo-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: #333;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 5px;
            user-select: none;
        }

        .page-button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
        }

        .page-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .page-button.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Cadastro de Reservas</h1>

        <div class="resumo-container">
            <div class="resumo-card">
                <h3>Total de Reservas</h3>
                <p id="total-reservas">0</p>
            </div>
            <div class="resumo-card">
                <h3>Confirmadas</h3>
                <p id="total-confirmadas">0</p>
            </div>
            <div class="resumo-card">
                <h3>Canceladas</h3>
                <p id="total-canceladas">0</p>
            </div>
            <div id="reservas-7dias-card" class="resumo-card">
                <h3>Próximos 7 Dias</h3>
                <p id="reservas-7dias">0</p>
            </div>
        </div>

        <div id="mensagem-sucesso" class="mensagem-sucesso">
            Reserva adicionada com sucesso!
        </div>

        <form id="form-reserva">
            <div class="input-group">
                <label for="data">Data:</label>
                <input type="date" id="data" required>
            </div>
            <div class="input-group">
                <label for="descricao">Descrição:</label>
                <input type="text" id="descricao" placeholder="Ex: Churrasqueira, Salão de Festas" required>
            </div>
            <div class="input-group">
                <label for="responsavel">Responsável:</label>
                <input type="text" id="responsavel" required>
            </div>
            <div class="input-group">
                <label for="contato">Contato:</label>
                <input type="text" id="contato" placeholder="(99) 99999-9999" required maxlength="15">
            </div>
            <div class="input-group">
                <label for="observacoes">Observações:</label>
                <textarea id="observacoes" placeholder="Adicione notas ou observações"></textarea>
            </div>
            <div class="input-group">
                <label for="usuario">Quem fez a reserva:</label>
                <input type="text" id="usuario" placeholder="Quem fez a reserva" required>
            </div>
            <button id="btn-form-reserva" type="submit">Adicionar Reserva</button>
            <button id="btn-cancelar-edicao" class="btn-cancelar-edicao" style="display:none;" type="button">Cancelar Edição</button>
        </form>

        <hr>

        <div class="filtros-container">
            <div class="filtro-item">
                <label for="filtro-pesquisa">Pesquisar:</label>
                <input type="text" id="filtro-pesquisa" placeholder="Buscar por responsável ou descrição">
            </div>
            <div class="filtro-item">
                <label for="filtro-status">Filtrar por Status:</label>
                <select id="filtro-status">
                    <option value="ativos">Reservados e Confirmados</option>
                    <option value="reservado">Reservados</option>
                    <option value="confirmado">Confirmados</option>
                    <option value="realizado">Realizados</option>
                    <option value="cancelado">Cancelados</option>
                    <option value="todos">Todos</option>
                </select>
            </div>
            <div class="filtro-item">
                <label for="data-inicio">De:</label>
                <input type="date" id="data-inicio">
            </div>
            <div class="filtro-item">
                <label for="data-fim">Até:</label>
                <input type="date" id="data-fim">
            </div>
        </div>

        <h2>Reservas Cadastradas</h2>
        
        <div id="tabela-para-pdf" class="tabela-wrapper">
            <table id="tabela-reservas">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Responsável</th>
                        <th>Contato</th>
                        <th>Observações</th>
                        <th>Status</th>
                        <th>Criador / Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div id="pagination-container" class="pagination-container"></div>
        
        <div class="botoes-acao">
            <button id="gerar-pdf-btn" class="btn-pdf">Gerar PDF</button>
            <button id="gerar-csv-btn" class="btn-csv">Gerar Excel (CSV)</button>
            <button id="fechar-pagina-btn" class="btn-fechar">Fechar Página</button>
        </div>
        <div style="text-align: right; font-size: 14px; margin-top: 15px;">
            <p id="ultimo-usuario-info"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formReserva = document.getElementById('form-reserva');
            const tabelaReservasBody = document.querySelector('#tabela-reservas tbody');
            const filtroStatusSelect = document.getElementById('filtro-status');
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            const filtroPesquisaInput = document.getElementById('filtro-pesquisa'); 
            const gerarPdfBtn = document.getElementById('gerar-pdf-btn');
            const gerarCsvBtn = document.getElementById('gerar-csv-btn');
            const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');
            const mensagemSucesso = document.getElementById('mensagem-sucesso');
            const btnFormReserva = document.getElementById('btn-form-reserva');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');
            const contatoInput = document.getElementById('contato');
            const usuarioInput = document.getElementById('usuario');
            const observacoesInput = document.getElementById('observacoes');
            const ultimoUsuarioInfo = document.getElementById('ultimo-usuario-info');

            const totalReservasElement = document.getElementById('total-reservas');
            const totalConfirmadasElement = document.getElementById('total-confirmadas');
            const totalCanceladasElement = document.getElementById('total-canceladas');
            const reservas7diasElement = document.getElementById('reservas-7dias');
            const reservas7diasCard = document.getElementById('reservas-7dias-card');
            const paginationContainer = document.getElementById('pagination-container');

            let reservaParaEditar = null;
            const itemsPerPage = 10;
            let currentPage = 1;

            const firebaseConfig = {
                apiKey: "AIzaSyDut5CV-mDqnuKV0MH8MM2ivOQMP-AF94E",
                authDomain: "reserva-b5ff4.firebaseapp.com",
                databaseURL: "https://reserva-b5ff4-default-rtdb.firebaseio.com",
                projectId: "reserva-b5ff4",
                storageBucket: "reserva-b5ff4.firebasestorage.app",
                messagingSenderId: "540617636797",
                appId: "1:540617636797:web:5081ca29f77cb9c5fab0d4"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const reservasRef = database.ref('reservas');
            
            let reservas = [];

            reservasRef.on('value', (snapshot) => {
                const data = snapshot.val();
                reservas = [];
                for (let key in data) {
                    reservas.push({ ...data[key], id: key });
                }
                ordenarReservas();
                renderizarTabela();
                atualizarUltimoUsuarioNaPagina();
                atualizarResumo();
            });

            formReserva.addEventListener('submit', (e) => {
                e.preventDefault();

                if (!contatoInput.value) {
                    alert('O campo Contato é obrigatório.');
                    return;
                }
                if (!usuarioInput.value) {
                    alert('O campo Quem fez a reserva é obrigatório.');
                    return;
                }

                const dataInput = document.getElementById('data');
                const descricaoInput = document.getElementById('descricao');
                const dataSelecionada = new Date(dataInput.value + 'T00:00:00');
                const dataAtual = new Date();
                dataAtual.setHours(0, 0, 0, 0);

                if (dataSelecionada < dataAtual) {
                    alert('Não é possível adicionar reservas em uma data que já passou.');
                    return;
                }

                const conflitoExistente = reservas.some(reserva => 
                    reserva.data === dataInput.value &&
                    reserva.descricao.toLowerCase() === descricaoInput.value.toLowerCase() &&
                    reserva.status === 'Confirmado' &&
                    (!reservaParaEditar || reserva.id !== reservaParaEditar.id)
                );

                if (conflitoExistente) {
                    alert('Já existe uma reserva CONFIRMADA para esta data e descrição. Por favor, escolha outra.');
                    return;
                }

                const dadosReserva = {
                    data: dataInput.value,
                    descricao: descricaoInput.value,
                    responsavel: document.getElementById('responsavel').value,
                    contato: contatoInput.value,
                    observacoes: observacoesInput.value,
                    ultimoUsuario: usuarioInput.value
                };

                if (reservaParaEditar) {
                    reservasRef.child(reservaParaEditar.id).update(dadosReserva)
                        .then(() => {
                            mostrarMensagemSucesso("Reserva atualizada com sucesso!");
                            formReserva.reset();
                            resetarFormulario();
                        })
                        .catch(error => console.error("Erro ao atualizar reserva: ", error));

                } else {
                    dadosReserva.status = 'Reservado';
                    reservasRef.push(dadosReserva)
                        .then(() => {
                            mostrarMensagemSucesso("Reserva adicionada com sucesso!");
                            formReserva.reset();
                        })
                        .catch(error => {
                            console.error("Erro ao adicionar reserva: ", error);
                        });
                }
            });

            contatoInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';

                if (value.length > 0) {
                    formattedValue = '(' + value.substring(0, 2);
                }
                if (value.length >= 3) {
                    formattedValue += ') ' + value.substring(2, 7);
                }
                if (value.length >= 8) {
                    formattedValue += '-' + value.substring(7, 11);
                }

                e.target.value = formattedValue;
            });


            filtroStatusSelect.addEventListener('change', () => {
                currentPage = 1;
                renderizarTabela();
            });
            dataInicioInput.addEventListener('change', () => {
                currentPage = 1;
                renderizarTabela();
            });
            dataFimInput.addEventListener('change', () => {
                currentPage = 1;
                renderizarTabela();
            });
            filtroPesquisaInput.addEventListener('input', () => {
                currentPage = 1;
                renderizarTabela();
            });

            gerarPdfBtn.addEventListener('click', () => {
                const tabelaParaPdf = document.getElementById('tabela-para-pdf');
                
                const linhas = document.querySelectorAll('#tabela-reservas tbody tr');
                const estadosCores = Array.from(linhas).map(linha => {
                    return {
                        element: linha,
                        corClass: Array.from(linha.classList).find(cls => cls.endsWith('-row'))
                    };
                });

                linhas.forEach(linha => linha.classList.remove('reservado-row', 'confirmado-row', 'cancelado-row', 'realizado-row'));
                const thAcoes = document.querySelector('th:last-child');
                const tdAcoes = document.querySelectorAll('td:last-child');
                thAcoes.style.display = 'none';
                tdAcoes.forEach(td => td.style.display = 'none');

                const thObservacoes = document.querySelector('th:nth-child(5)');
                const tdObservacoes = document.querySelectorAll('td:nth-child(5)');
                thObservacoes.style.display = 'none';
                tdObservacoes.forEach(td => td.style.display = 'none');
                
                tabelaParaPdf.style.fontSize = '12px';

                html2pdf(tabelaParaPdf, {
                    margin: 10,
                    filename: 'reservas_clube.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).then(() => {
                    tabelaParaPdf.style.fontSize = '';
                    thAcoes.style.display = '';
                    tdAcoes.forEach(td => td.style.display = '');

                    thObservacoes.style.display = '';
                    tdObservacoes.forEach(td => td.style.display = '');

                    estadosCores.forEach(estado => {
                        if (estado.corClass) {
                            estado.element.classList.add(estado.corClass);
                        }
                    });
                });
            });

            gerarCsvBtn.addEventListener('click', () => {
                const dadosTabela = [];
                const cabecalho = ['Data', 'Descricao', 'Responsavel', 'Contato', 'Observacoes', 'Status', 'Criador'];
                dadosTabela.push(cabecalho.join(';'));
                
                const linhas = document.querySelectorAll('#tabela-reservas tbody tr');
                linhas.forEach(linha => {
                    const celulas = linha.querySelectorAll('td');
                    const status = linha.querySelector('.status-select')?.value || linha.querySelector('.status-badge').textContent;
                    const dadosLinha = [
                        celulas[0].textContent,
                        celulas[1].textContent,
                        celulas[2].textContent,
                        celulas[3].textContent,
                        celulas[4].textContent,
                        status,
                        celulas[6].textContent.replace('EditarExcluir', '').trim()
                    ];
                    dadosTabela.push(dadosLinha.join(';'));
                });

                const csvContent = "data:text/csv;charset=utf-8," + dadosTabela.join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "reservas_clube.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            fecharPaginaBtn.addEventListener('click', () => {
                window.close();
            });
            
            tabelaReservasBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-editar')) {
                    const idReserva = e.target.closest('tr').dataset.id;
                    editarReserva(idReserva);
                }
                if (e.target.classList.contains('btn-excluir')) {
                    const idReserva = e.target.closest('tr').dataset.id;
                    if (confirm("Tem certeza que deseja excluir esta reserva? Esta ação não pode ser desfeita.")) {
                        reservasRef.child(idReserva).remove()
                            .then(() => mostrarMensagemSucesso("Reserva excluída com sucesso!"))
                            .catch(error => console.error("Erro ao excluir reserva: ", error));
                    }
                }
                
                if (e.target.classList.contains('status-badge')) {
                    const idReserva = e.target.closest('tr').dataset.id;
                    const cell = e.target.closest('td');
                    abrirOpcoesStatus(idReserva, cell);
                }
            });

            btnCancelarEdicao.addEventListener('click', () => {
                resetarFormulario();
            });

            function formatarData(dataString) {
                const [ano, mes, dia] = dataString.split('-');
                return `${dia}-${mes}-${ano}`;
            }

            function editarReserva(id) {
                reservaParaEditar = reservas.find(res => res.id === id);
                if (reservaParaEditar) {
                    document.getElementById('data').value = reservaParaEditar.data;
                    document.getElementById('descricao').value = reservaParaEditar.descricao;
                    document.getElementById('responsavel').value = reservaParaEditar.responsavel;
                    document.getElementById('contato').value = reservaParaEditar.contato;
                    document.getElementById('observacoes').value = reservaParaEditar.observacoes || '';
                    document.getElementById('usuario').value = reservaParaEditar.ultimoUsuario || '';
                    
                    btnFormReserva.textContent = "Salvar Alterações";
                    btnFormReserva.style.backgroundColor = "#ffc107";
                    btnFormReserva.style.color = "#000";
                    btnCancelarEdicao.style.display = "inline-block";
                }
            }

            function resetarFormulario() {
                formReserva.reset();
                btnFormReserva.textContent = "Adicionar Reserva";
                btnFormReserva.style.backgroundColor = "#28a745";
                btnFormReserva.style.color = "#fff";
                btnCancelarEdicao.style.display = "none";
                reservaParaEditar = null;
            }

            function mostrarMensagemSucesso(mensagem) {
                mensagemSucesso.textContent = mensagem;
                mensagemSucesso.style.display = 'block';
                setTimeout(() => {
                    mensagemSucesso.style.display = 'none';
                }, 3000);
            }

            function ordenarReservas() {
                reservas.sort((a, b) => {
                    return new Date(a.data) - new Date(b.data);
                });
            }

            function atualizarResumo() {
                const total = reservas.length;
                const confirmadas = reservas.filter(res => res.status === 'Confirmado').length;
                const canceladas = reservas.filter(res => res.status === 'Cancelado').length;

                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const dataLimite7Dias = new Date();
                dataLimite7Dias.setDate(hoje.getDate() + 7);

                const proximos7Dias = reservas.filter(res => {
                    const dataReserva = new Date(res.data + 'T00:00:00');
                    const statusAtivo = res.status === 'Reservado' || res.status === 'Confirmado';
                    return dataReserva >= hoje && dataReserva <= dataLimite7Dias && statusAtivo;
                }).length;

                totalReservasElement.textContent = total;
                totalConfirmadasElement.textContent = confirmadas;
                totalCanceladasElement.textContent = canceladas;
                reservas7diasElement.textContent = proximos7Dias;

                if (proximos7Dias > 0) {
                    reservas7diasCard.classList.add('alerta-vermelho');
                } else {
                    reservas7diasCard.classList.remove('alerta-vermelho');
                }
            }

            function renderizarTabela() {
                tabelaReservasBody.innerHTML = '';
                const filtroStatus = filtroStatusSelect.value;
                const dataInicio = dataInicioInput.value;
                const dataFim = dataFimInput.value;
                const termoPesquisa = filtroPesquisaInput.value.toLowerCase();
                
                let reservasFiltradas = reservas.filter(reserva => {
                    let statusValido = false;
                    if (filtroStatus === 'ativos') {
                        statusValido = reserva.status === 'Reservado' || reserva.status === 'Confirmado';
                    } else if (filtroStatus === 'reservado') {
                        statusValido = reserva.status === 'Reservado';
                    } else if (filtroStatus === 'confirmado') {
                        statusValido = reserva.status === 'Confirmado';
                    } else if (filtroStatus === 'cancelado') {
                        statusValido = reserva.status === 'Cancelado';
                    } else if (filtroStatus === 'realizado') {
                        statusValido = reserva.status === 'Realizado';
                    } else { 
                        statusValido = true;
                    }
                    
                    const dataReserva = new Date(reserva.data + 'T00:00:00');
                    const dataInicioValida = !dataInicio || dataReserva >= new Date(dataInicio + 'T00:00:00');
                    const dataFimValida = !dataFim || dataReserva <= new Date(dataFim + 'T00:00:00');
                    
                    const pesquisaValida = termoPesquisa === '' ||
                        reserva.responsavel.toLowerCase().includes(termoPesquisa) ||
                        reserva.descricao.toLowerCase().includes(termoPesquisa) ||
                        (reserva.ultimoUsuario && reserva.ultimoUsuario.toLowerCase().includes(termoPesquisa)) ||
                        (reserva.observacoes && reserva.observacoes.toLowerCase().includes(termoPesquisa));

                    return statusValido && dataInicioValida && dataFimValida && pesquisaValida;
                });

                const totalPaginas = Math.ceil(reservasFiltradas.length / itemsPerPage);
                const inicio = (currentPage - 1) * itemsPerPage;
                const fim = inicio + itemsPerPage;
                const reservasPaginadas = reservasFiltradas.slice(inicio, fim);
                
                reservasPaginadas.forEach(reserva => {
                    const novaLinha = document.createElement('tr');
                    novaLinha.dataset.id = reserva.id;
                    
                    if (reserva.status === 'Reservado') {
                        novaLinha.classList.add('reservado-row');
                    } else if (reserva.status === 'Confirmado') {
                        novaLinha.classList.add('confirmado-row');
                    } else if (reserva.status === 'Cancelado') {
                        novaLinha.classList.add('cancelado-row');
                    } else if (reserva.status === 'Realizado') {
                        novaLinha.classList.add('realizado-row');
                    }
                    
                    const numeroLimpo = reserva.contato.replace(/\D/g, '');

                    novaLinha.innerHTML = `
                        <td>${formatarData(reserva.data)}</td>
                        <td>${reserva.descricao}</td>
                        <td>${reserva.responsavel}</td>
                        <td>
                            <a href="https://wa.me/55${numeroLimpo}" target="_blank">${reserva.contato}</a>
                        </td>
                        <td>${reserva.observacoes || ''}</td>
                        <td>
                            <span class="status-badge badge-${reserva.status.toLowerCase()}">${reserva.status}</span>
                        </td>
                        <td>
                            ${reserva.ultimoUsuario || 'N/A'}
                            <div style="margin-top: 5px; display: flex; gap: 5px; justify-content: center;">
                                <button class="btn-editar">Editar</button>
                                <button class="btn-excluir">Excluir</button>
                            </div>
                        </td>
                    `;
                    
                    tabelaReservasBody.appendChild(novaLinha);
                });
                
                renderizarPaginacao(totalPaginas);
            }

            function renderizarPaginacao(totalPaginas) {
                paginationContainer.innerHTML = '';
                
                const prevButton = document.createElement('button');
                prevButton.textContent = 'Anterior';
                prevButton.classList.add('page-button');
                if (currentPage === 1) prevButton.classList.add('disabled');
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderizarTabela();
                    }
                });
                paginationContainer.appendChild(prevButton);
                
                for (let i = 1; i <= totalPaginas; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.classList.add('page-button');
                    if (i === currentPage) pageButton.classList.add('active');
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderizarTabela();
                    });
                    paginationContainer.appendChild(pageButton);
                }
                
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Próximo';
                nextButton.classList.add('page-button');
                if (currentPage === totalPaginas) nextButton.classList.add('disabled');
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPaginas) {
                        currentPage++;
                        renderizarTabela();
                    }
                });
                paginationContainer.appendChild(nextButton);
            }
            
            function abrirOpcoesStatus(id, cell) {
                const reserva = reservas.find(res => res.id === id);
                if (!reserva) return;
                
                const statusSelect = document.createElement('select');
                statusSelect.classList.add('status-select');
                statusSelect.innerHTML = `
                    <option value="Reservado" ${reserva.status === 'Reservado' ? 'selected' : ''}>Reservado</option>
                    <option value="Confirmado" ${reserva.status === 'Confirmado' ? 'selected' : ''}>Confirmado</option>
                    <option value="Cancelado" ${reserva.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                    <option value="Realizado" ${reserva.status === 'Realizado' ? 'selected' : ''}>Realizado</option>
                `;
                
                cell.innerHTML = '';
                cell.appendChild(statusSelect);
                statusSelect.focus();
                
                statusSelect.addEventListener('change', (e) => {
                    const novoStatus = e.target.value;
                    reservasRef.child(reserva.id).update({ status: novoStatus })
                        .then(() => {
                            console.log("Status atualizado com sucesso!");
                        })
                        .catch(error => console.error("Erro ao atualizar status: ", error));
                });
                
                statusSelect.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (!document.activeElement.isEqualNode(statusSelect)) {
                            renderizarTabela();
                        }
                    }, 100);
                });
            }
            
            function atualizarUltimoUsuarioNaPagina() {
                reservasRef.orderByKey().limitToLast(1).once('value', (snapshot) => {
                    const ultimoRegistro = snapshot.val();
                    if (ultimoRegistro) {
                        const ultimoId = Object.keys(ultimoRegistro)[0];
                        const dados = ultimoRegistro[ultimoId];
                        if (dados.ultimoUsuario) {
                            ultimoUsuarioInfo.textContent = `Última alteração feita por: ${dados.ultimoUsuario}`;
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>