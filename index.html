<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Reservas do Clube</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            text-align: center;
            color: #333;
        }

        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        #btn-form-reserva {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        #btn-form-reserva:hover {
            background-color: #218838;
        }

        .filtros-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filtro-item {
            flex: 1;
            margin-right: 10px;
        }

        .filtro-item:last-child {
            margin-right: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            color: #333;
        }

        .status-select {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .status-reservado {
            color: #007bff;
            font-weight: bold;
        }

        .status-confirmado {
            color: #28a745;
            font-weight: bold;
        }

        .status-cancelado {
            color: #dc3545;
            font-weight: bold;
        }
        
        .botoes-acao {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .botoes-acao button {
            width: 100%;
            margin-top: 0;
        }

        .btn-pdf {
            background-color: #007bff;
        }

        .btn-pdf:hover {
            background-color: #0056b3;
        }

        .btn-fechar {
            background-color: #6c757d;
        }

        .btn-fechar:hover {
            background-color: #5a6268;
        }

        .mensagem-sucesso {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
            display: none; /* Inicia escondida */
        }
        
        .btn-editar, .btn-cancelar-edicao {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-editar {
            background-color: #ffc107;
            color: #000;
        }

        .btn-cancelar-edicao {
            background-color: #dc3545;
            color: #fff;
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Cadastro de Reservas</h1>

        <div id="mensagem-sucesso" class="mensagem-sucesso">
            Reserva adicionada com sucesso!
        </div>

        <form id="form-reserva">
            <div class="input-group">
                <label for="data">Data:</label>
                <input type="date" id="data" required>
            </div>
            <div class="input-group">
                <label for="descricao">Descrição:</label>
                <input type="text" id="descricao" placeholder="Ex: Churrasqueira, Salão de Festas" required>
            </div>
            <div class="input-group">
                <label for="responsavel">Responsável:</label>
                <input type="text" id="responsavel" required>
            </div>
            <div class="input-group">
                <label for="contato">Contato:</label>
                <input type="text" id="contato" placeholder="(99) 99999-9999" required maxlength="15">
            </div>
            <div class="input-group">
                <label for="usuario">Quem fez a reserva:</label>
                <input type="text" id="usuario" placeholder="Quem fez a reserva" required>
            </div>
            <button id="btn-form-reserva" type="submit">Adicionar Reserva</button>
            <button id="btn-cancelar-edicao" class="btn-cancelar-edicao" style="display:none;" type="button">Cancelar Edição</button>
        </form>

        <hr>

        <div class="filtros-container">
            <div class="filtro-item">
                <label for="filtro-status">Filtrar por Status:</label>
                <select id="filtro-status">
                    <option value="ativos">Reservados e Confirmados</option>
                    <option value="reservado">Reservados</option>
                    <option value="confirmado">Confirmados</option>
                    <option value="cancelado">Cancelados</option>
                    <option value="todos">Todos</option>
                </select>
            </div>
            <div class="filtro-item">
                <label for="data-inicio">De:</label>
                <input type="date" id="data-inicio">
            </div>
            <div class="filtro-item">
                <label for="data-fim">Até:</label>
                <input type="date" id="data-fim">
            </div>
        </div>

        <h2>Reservas Cadastradas</h2>
        
        <div id="tabela-para-pdf">
            <table id="tabela-reservas">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Responsável</th>
                        <th>Contato</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div class="botoes-acao">
            <button id="gerar-pdf-btn" class="btn-pdf">Gerar PDF</button>
            <button id="fechar-pagina-btn" class="btn-fechar">Fechar Página</button>
        </div>
        <div style="text-align: right; font-size: 14px; margin-top: 15px;">
            <p id="ultimo-usuario-info"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const formReserva = document.getElementById('form-reserva');
            const tabelaReservasBody = document.querySelector('#tabela-reservas tbody');
            const filtroStatusSelect = document.getElementById('filtro-status');
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            const gerarPdfBtn = document.getElementById('gerar-pdf-btn');
            const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');
            const mensagemSucesso = document.getElementById('mensagem-sucesso');
            const btnFormReserva = document.getElementById('btn-form-reserva');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');
            const contatoInput = document.getElementById('contato');
            const usuarioInput = document.getElementById('usuario');
            const ultimoUsuarioInfo = document.getElementById('ultimo-usuario-info');
            
            let reservaParaEditar = null;

            // Configuração do Firebase com suas chaves
            const firebaseConfig = {
                apiKey: "AIzaSyDut5CV-mDqnuKV0MH8MM2ivOQMP-AF94E",
                authDomain: "reserva-b5ff4.firebaseapp.com",
                databaseURL: "https://reserva-b5ff4-default-rtdb.firebaseio.com",
                projectId: "reserva-b5ff4",
                storageBucket: "reserva-b5ff4.firebasestorage.app",
                messagingSenderId: "540617636797",
                appId: "1:540617636797:web:5081ca29f77cb9c5fab0d4"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const reservasRef = database.ref('reservas');
            
            let reservas = [];

            reservasRef.on('value', (snapshot) => {
                const data = snapshot.val();
                reservas = [];
                for (let key in data) {
                    reservas.push({ ...data[key], id: key });
                }
                ordenarReservas();
                renderizarTabela();
                atualizarUltimoUsuarioNaPagina();
            });

            formReserva.addEventListener('submit', (e) => {
                e.preventDefault();

                // Validação do campo de contato e usuário
                if (!contatoInput.value) {
                    alert('O campo Contato é obrigatório.');
                    return;
                }
                if (!usuarioInput.value) {
                    alert('O campo Quem fez a reserva é obrigatório.');
                    return;
                }

                const dataInput = document.getElementById('data');
                const dataSelecionada = new Date(dataInput.value + 'T00:00:00');
                const dataAtual = new Date();
                dataAtual.setHours(0, 0, 0, 0);

                if (dataSelecionada < dataAtual) {
                    alert('Não é possível adicionar reservas em uma data que já passou.');
                    return;
                }

                const dadosReserva = {
                    data: dataInput.value,
                    descricao: document.getElementById('descricao').value,
                    responsavel: document.getElementById('responsavel').value,
                    contato: document.getElementById('contato').value,
                    ultimoUsuario: usuarioInput.value
                };

                if (reservaParaEditar) {
                    // Modo de edição: atualiza a reserva existente
                    reservasRef.child(reservaParaEditar.id).update(dadosReserva)
                        .then(() => {
                            mostrarMensagemSucesso("Reserva atualizada com sucesso!");
                            formReserva.reset();
                            resetarFormulario();
                        })
                        .catch(error => console.error("Erro ao atualizar reserva: ", error));

                } else {
                    // Modo de adição: adiciona uma nova reserva
                    dadosReserva.status = 'Reservado';
                    reservasRef.push(dadosReserva)
                        .then(() => {
                            mostrarMensagemSucesso("Reserva adicionada com sucesso!");
                            formReserva.reset();
                        })
                        .catch(error => {
                            console.error("Erro ao adicionar reserva: ", error);
                        });
                }
            });

            // Adiciona o ouvinte de eventos para a máscara
            contatoInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';

                if (value.length > 0) {
                    formattedValue = '(' + value.substring(0, 2);
                }
                if (value.length >= 3) {
                    formattedValue += ') ' + value.substring(2, 7);
                }
                if (value.length >= 8) {
                    formattedValue += '-' + value.substring(7, 11);
                }

                e.target.value = formattedValue;
            });


            filtroStatusSelect.addEventListener('change', renderizarTabela);
            dataInicioInput.addEventListener('change', renderizarTabela);
            dataFimInput.addEventListener('change', renderizarTabela);

            gerarPdfBtn.addEventListener('click', () => {
                const tabelaParaPdf = document.getElementById('tabela-para-pdf');
                
                // Define temporariamente a fonte para o PDF
                tabelaParaPdf.style.fontSize = '12px';

                // Esconde a coluna inteira de Ações
                const thAcoes = document.querySelector('th:last-child');
                const tdAcoes = document.querySelectorAll('td:last-child');
                
                thAcoes.style.display = 'none';
                tdAcoes.forEach(td => td.style.display = 'none');

                html2pdf(tabelaParaPdf, {
                    margin: 10,
                    filename: 'reservas_clube.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).then(() => {
                    // Mostra a coluna de Ações e restaura a fonte após a geração do PDF
                    thAcoes.style.display = '';
                    tdAcoes.forEach(td => td.style.display = '');
                    tabelaParaPdf.style.fontSize = ''; // Restaura o tamanho da fonte
                });
            });

            fecharPaginaBtn.addEventListener('click', () => {
                window.close();
            });
            
            // Adiciona um listener para os botões de editar na tabela
            tabelaReservasBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-editar')) {
                    const idReserva = e.target.closest('tr').dataset.id;
                    editarReserva(idReserva);
                }
            });

            // Adiciona um listener para o botão de cancelar edição
            btnCancelarEdicao.addEventListener('click', () => {
                resetarFormulario();
            });

            // Nova função para formatar a data
            function formatarData(dataString) {
                const [ano, mes, dia] = dataString.split('-');
                return `${dia}-${mes}-${ano}`;
            }

            function editarReserva(id) {
                reservaParaEditar = reservas.find(res => res.id === id);
                if (reservaParaEditar) {
                    document.getElementById('data').value = reservaParaEditar.data;
                    document.getElementById('descricao').value = reservaParaEditar.descricao;
                    document.getElementById('responsavel').value = reservaParaEditar.responsavel;
                    document.getElementById('contato').value = reservaParaEditar.contato;
                    document.getElementById('usuario').value = reservaParaEditar.ultimoUsuario || '';
                    
                    btnFormReserva.textContent = "Salvar Alterações";
                    btnFormReserva.style.backgroundColor = "#ffc107";
                    btnFormReserva.style.color = "#000";
                    btnCancelarEdicao.style.display = "inline-block";
                }
            }

            function resetarFormulario() {
                formReserva.reset();
                btnFormReserva.textContent = "Adicionar Reserva";
                btnFormReserva.style.backgroundColor = "#28a745";
                btnFormReserva.style.color = "#fff";
                btnCancelarEdicao.style.display = "none";
                reservaParaEditar = null;
            }

            function mostrarMensagemSucesso(mensagem) {
                mensagemSucesso.textContent = mensagem;
                mensagemSucesso.style.display = 'block';
                setTimeout(() => {
                    mensagemSucesso.style.display = 'none';
                }, 3000);
            }

            function ordenarReservas() {
                reservas.sort((a, b) => {
                    return new Date(a.data) - new Date(b.data);
                });
            }

            function renderizarTabela() {
                tabelaReservasBody.innerHTML = '';
                const filtroStatus = filtroStatusSelect.value;
                const dataInicio = dataInicioInput.value;
                const dataFim = dataFimInput.value;
                
                let reservasFiltradas = reservas.filter(reserva => {
                    let statusValido = false;
                    if (filtroStatus === 'ativos') {
                        statusValido = reserva.status === 'Reservado' || reserva.status === 'Confirmado';
                    } else if (filtroStatus === 'reservado') {
                        statusValido = reserva.status === 'Reservado';
                    } else if (filtroStatus === 'confirmado') {
                        statusValido = reserva.status === 'Confirmado';
                    } else if (filtroStatus === 'cancelado') {
                        statusValido = reserva.status === 'Cancelado';
                    } else { // 'todos'
                        statusValido = true;
                    }
                    
                    const dataReserva = new Date(reserva.data + 'T00:00:00');
                    const dataInicioValida = !dataInicio || dataReserva >= new Date(dataInicio + 'T00:00:00');
                    const dataFimValida = !dataFim || dataReserva <= new Date(dataFim + 'T00:00:00');

                    return statusValido && dataInicioValida && dataFimValida;
                });

                reservasFiltradas.forEach(reserva => {
                    const novaLinha = document.createElement('tr');
                    novaLinha.dataset.id = reserva.id;
                    novaLinha.innerHTML = `
                        <td>${formatarData(reserva.data)}</td>
                        <td>${reserva.descricao}</td>
                        <td>${reserva.responsavel}</td>
                        <td>${reserva.contato}</td>
                        <td>
                            <select class="status-select">
                                <option value="Reservado" ${reserva.status === 'Reservado' ? 'selected' : ''}>Reservado</option>
                                <option value="Confirmado" ${reserva.status === 'Confirmado' ? 'selected' : ''}>Confirmado</option>
                                <option value="Cancelado" ${reserva.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </td>
                        <td>
                            <button class="btn-editar">Editar</button>
                        </td>
                    `;
                    
                    tabelaReservasBody.appendChild(novaLinha);

                    const selectStatus = novaLinha.querySelector('.status-select');
                    atualizarEstiloStatus(selectStatus, reserva.status);

                    selectStatus.addEventListener('change', (e) => {
                        const novoStatus = e.target.value;
                        reservasRef.child(reserva.id).update({ status: novoStatus })
                            .then(() => console.log("Status atualizado com sucesso!"))
                            .catch(error => console.error("Erro ao atualizar status: ", error));
                    });
                });
            }

            function atualizarEstiloStatus(selectElement, status) {
                selectElement.className = 'status-select';
                if (status === 'Reservado') {
                    selectElement.classList.add('status-reservado');
                } else if (status === 'Confirmado') {
                    selectElement.classList.add('status-confirmado');
                } else if (status === 'Cancelado') {
                    selectElement.classList.add('status-cancelado');
                }
            }
            
            function atualizarUltimoUsuarioNaPagina() {
                reservasRef.orderByKey().limitToLast(1).once('value', (snapshot) => {
                    const ultimoRegistro = snapshot.val();
                    if (ultimoRegistro) {
                        const ultimoId = Object.keys(ultimoRegistro)[0];
                        const dados = ultimoRegistro[ultimoId];
                        if (dados.ultimoUsuario) {
                            ultimoUsuarioInfo.textContent = `Última alteração feita por: ${dados.ultimoUsuario}`;
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>