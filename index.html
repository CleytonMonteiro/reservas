<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Reservas - AABB Aracaju</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#003399">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- TELA DE LOGIN --- */
        #login-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            /* Fundo azul degrad√™ para combinar com a identidade da AABB */
            background: linear-gradient(135deg, #003399 0%, #1a53ff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        /* Estilo da Logo na tela de Login */
        .login-logo {
            max-width: 220px; /* Tamanho m√°ximo da logo */
            height: auto;
            display: block;
            margin: 0 auto 20px auto; /* Centraliza e d√° espa√ßo embaixo */
        }

        .login-box h2 { 
            margin-bottom: 5px; 
            color: #003399; /* Azul AABB */
            font-weight: 700;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 25px;
            font-size: 13px;
        }

        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;
            background-color: #f9f9f9;
        }
        .login-box input:focus {
            border-color: #ffc107; /* Amarelo AABB no foco */
            outline: none;
            background-color: #fff;
        }

        .login-btn {
            width: 100%; padding: 12px; 
            background: #003399; /* Azul AABB */
            color: white;
            border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
            transition: background 0.3s;
        }
        .login-btn:hover { background: #002266; }
        
        #login-error { color: #dc3545; margin-top: 10px; display: none; font-size: 12px;}

        /* --- AREA DO SISTEMA --- */
        #app-container {
            display: none;
            padding: 20px;
            flex-grow: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 25px 35px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        /* Header com Logout */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ffc107; /* Detalhe amarelo */
            padding-bottom: 15px;
        }
        
        .header-title h1 {
            text-align: left;
            margin: 0;
            color: #003399;
            font-size: 24px;
        }
        
        .header-title span {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }

        .btn-logout {
            background: #dc3545; color: white; padding: 8px 15px;
            border: none; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .btn-logout:hover { background-color: #c82333; }

        /* --- Formul√°rio --- */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 14px;
        }
        .input-group input:focus { border-color: #003399; outline: none; }
        
        #btn-form-reserva {
            width: 100%; padding: 12px; background-color: #28a745; color: #fff; border: none;
            border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: background 0.3s;
        }
        #btn-form-reserva:hover { background-color: #218838; }
        #btn-form-reserva:disabled { background-color: #94d3a2; cursor: not-allowed; }

        /* --- View Toggle --- */
        .view-toggle-container {
            display: flex; justify-content: center; margin-bottom: 20px;
            background: #e9ecef; padding: 5px; border-radius: 8px; width: fit-content; margin-left: auto; margin-right: auto;
        }
        .view-btn {
            padding: 10px 25px; border: none; cursor: pointer; font-size: 14px; font-weight: bold;
            border-radius: 6px; background: transparent; color: #495057; transition: all 0.2s;
        }
        .view-btn.active { background: #fff; color: #003399; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* --- Filtros --- */
        .filtros-container {
            display: flex; justify-content: center; align-items: flex-end; margin-bottom: 25px;
            flex-wrap: wrap; gap: 15px; background-color: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;
        }
        .filtro-item { display: flex; flex-direction: column; }
        .filtro-item input, .filtro-item select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        /* --- Tabela --- */
        .tabela-wrapper { overflow-x: auto; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 0; table-layout: fixed; background: white; }
        table, th, td { border: 1px solid #dee2e6; }
        th, td { padding: 12px 15px; text-align: left; word-wrap: break-word; }
        th { background-color: #f1f3f5; color: #495057; font-weight: 600; text-transform: uppercase; font-size: 11px; }

        th:nth-child(1), td:nth-child(1) { width: 90px; }
        th:nth-child(2), td:nth-child(2) { width: 18%; }
        th:nth-child(3), td:nth-child(3) { width: 15%; }
        th:nth-child(4), td:nth-child(4) { width: 110px; }
        th:nth-child(5), td:nth-child(5) { width: 25%; }
        th:nth-child(6), td:nth-child(6) { width: 100px; text-align: center;}
        th:nth-child(7), td:nth-child(7) { width: 100px; text-align: center;}

        .confirmado-row { background-color: #d4edda; }
        .reservado-row { background-color: #fff3cd; }
        .cancelado-row { background-color: #f8d7da; }
        .realizado-row { background-color: #e2e3e5; }
        
        .status-badge {
            display: inline-block; padding: 5px 10px; border-radius: 50px; font-size: 11px; font-weight: bold;
            color: white; cursor: pointer; text-align: center; min-width: 80px;
        }
        .badge-reservado { background-color: #007bff; }
        .badge-confirmado { background-color: #28a745; }
        .badge-cancelado { background-color: #dc3545; }
        .badge-realizado { background-color: #6c757d; }
        
        /* --- Bot√µes e Componentes --- */
        .botoes-acao { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .botoes-acao button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-pdf { background-color: #17a2b8; }
        .btn-csv { background-color: #218838; }
        .btn-fechar { background-color: #6c757d; }

        .mensagem-sucesso {
            background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px;
            margin-bottom: 20px; text-align: center; display: none; font-weight: bold;
        }
        .btn-editar, .btn-cancelar-edicao, .btn-excluir {
            padding: 4px 8px; border: none; cursor: pointer; border-radius: 3px; font-size: 11px; margin: 2px;
        }
        .btn-editar { background-color: #ffc107; color: #000; }
        .btn-excluir { background-color: #dc3545; color: #fff; }
        .btn-cancelar-edicao { background-color: #dc3545; color: #fff; margin-left: 10px; }

        .resumo-container { display: flex; justify-content: space-between; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .resumo-card {
            background-color: #fff; border: 1px solid #e1e4e8; border-radius: 8px; padding: 15px; text-align: center;
            flex: 1; min-width: 140px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .resumo-card.alerta-vermelho { background-color: #fff5f5; border-color: #ffc9c9; color: #c92a2a; }
        .resumo-card h3 { margin: 0 0 8px; font-size: 13px; color: #666; text-transform: uppercase; }
        .resumo-card p { font-size: 28px; font-weight: bold; margin: 0; color: #003399; }
        .resumo-card.alerta-vermelho p { color: #c92a2a; }

        .pagination-container { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 5px; user-select: none; }
        .page-button {
            padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #fff; cursor: pointer; color: #007bff;
        }
        .page-button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .page-button.disabled { cursor: not-allowed; opacity: 0.5; color: #6c757d; }

        /* --- Calend√°rio --- */
        #calendar-container { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #e1e4e8; }
        .fc-event { cursor: pointer; border: none; }
        .fc-event-title { font-weight: bold; }
        .fc .fc-toolbar-title { font-size: 1.2em; color: #003399; }
        .fc .fc-button { padding: 0.4em 0.65em; font-size: 0.9em; background-color: #003399; border-color: #003399;}
        .fc .fc-button:hover { background-color: #002266; }

        /* --- Loading --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #003399; border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        .loading-text { color: #333; font-size: 18px; font-weight: bold; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div class="loading-text">Carregando sistema...</div>
    </div>

    <div id="login-container">
        <div class="login-box">
            <img src="Logo AABB 2025.png" alt="Logo AABB Aracaju 80 Anos" class="login-logo">
            
            <h2>Acesso Restrito</h2>
            <p>Fa√ßa login para gerenciar as reservas</p>
            
            <input type="email" id="login-email" placeholder="E-mail" required>
            <input type="password" id="login-password" placeholder="Senha" required>
            <button id="btn-login" class="login-btn">Entrar no Sistema</button>
            <div id="login-error">E-mail ou senha incorretos.</div>
        </div>
    </div>

    <div id="app-container">
        <div class="container">
            <div class="app-header">
                <div class="header-title">
                    <h1>AABB Aracaju</h1>
                    <span>Gest√£o de Reservas & Eventos</span>
                </div>
                <button id="btn-logout" class="btn-logout">Sair / Logout</button>
            </div>

            <div class="resumo-container">
                <div class="resumo-card">
                    <h3>Total</h3>
                    <p id="total-reservas">0</p>
                </div>
                <div class="resumo-card">
                    <h3>Confirmadas</h3>
                    <p id="total-confirmadas">0</p>
                </div>
                <div class="resumo-card">
                    <h3>Canceladas</h3>
                    <p id="total-canceladas">0</p>
                </div>
                <div id="reservas-7dias-card" class="resumo-card">
                    <h3>Pr√≥ximos 7 Dias</h3>
                    <p id="reservas-7dias">0</p>
                </div>
            </div>

            <div id="mensagem-sucesso" class="mensagem-sucesso"></div>

            <form id="form-reserva">
                <div class="input-group">
                    <label for="data">Data:</label>
                    <input type="date" id="data" required>
                </div>
                <div class="input-group">
                    <label for="descricao">Descri√ß√£o (Local/Evento):</label>
                    <input type="text" id="descricao" placeholder="Ex: Churrasqueira, Sal√£o de Festas, Anivers√°rio" required>
                </div>
                <div class="input-group">
                    <label for="responsavel">Nome do Respons√°vel:</label>
                    <input type="text" id="responsavel" required>
                </div>
                <div class="input-group">
                    <label for="contato">WhatsApp / Contato:</label>
                    <input type="text" id="contato" placeholder="(99) 99999-9999" required maxlength="15">
                </div>
                <div class="input-group">
                    <label for="observacoes">Observa√ß√µes:</label>
                    <textarea id="observacoes" placeholder="Adicione notas, hor√°rio espec√≠fico, ou detalhes extras" rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label for="usuario">Quem est√° registrando:</label>
                    <input type="text" id="usuario" placeholder="Seu nome" required>
                </div>
                
                <button id="btn-form-reserva" type="submit">Adicionar Reserva</button>
                <div style="text-align: right; margin-top: 5px;">
                    <button id="btn-cancelar-edicao" class="btn-cancelar-edicao" style="display:none;" type="button">Cancelar Edi√ß√£o</button>
                </div>
            </form>

            <hr>
            
            <div class="view-toggle-container">
                <button id="btn-view-lista" class="view-btn active">üìã Lista</button>
                <button id="btn-view-calendario" class="view-btn">üìÖ Calend√°rio</button>
            </div>

            <div id="section-lista">
                <div class="filtros-container">
                    <div class="filtro-item" style="flex-grow: 1;">
                        <label for="filtro-pesquisa">Pesquisar:</label>
                        <input type="text" id="filtro-pesquisa" placeholder="Nome, descri√ß√£o ou observa√ß√£o...">
                    </div>
                    <div class="filtro-item">
                        <label for="filtro-status">Status:</label>
                        <select id="filtro-status">
                            <option value="ativos">Reservados e Confirmados</option>
                            <option value="reservado">Apenas Reservados</option>
                            <option value="confirmado">Apenas Confirmados</option>
                            <option value="realizado">Realizados</option>
                            <option value="cancelado">Cancelados</option>
                            <option value="todos">Todos os Registros</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label for="data-inicio">De:</label>
                        <input type="date" id="data-inicio">
                    </div>
                    <div class="filtro-item">
                        <label for="data-fim">At√©:</label>
                        <input type="date" id="data-fim">
                    </div>
                    <div class="filtro-item">
                        <label for="qtd-por-pagina">Exibir:</label>
                        <select id="qtd-por-pagina">
                            <option value="10">10</option>
                            <option value="30" selected>30</option>
                            <option value="50">50</option>
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>&nbsp;</label>
                        <button type="button" id="btn-limpar-filtros" style="padding: 9px; cursor:pointer; border-radius:4px; border:1px solid #ccc;">Limpar</button>
                    </div>
                </div>

                <h2>Reservas Cadastradas</h2>
                
                <div id="tabela-para-pdf" class="tabela-wrapper">
                    <table id="tabela-reservas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descri√ß√£o</th>
                                <th>Respons√°vel</th>
                                <th>Contato</th>
                                <th>Observa√ß√µes</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="pagination-container" class="pagination-container"></div>
                
                <div class="botoes-acao">
                    <button id="gerar-pdf-btn" class="btn-pdf">Baixar PDF</button>
                    <button id="gerar-csv-btn" class="btn-csv">Baixar Excel (CSV)</button>
                    <button id="fechar-pagina-btn" class="btn-fechar">Sair</button>
                </div>
            </div>

            <div id="section-calendario" class="hidden">
                <div id="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>

            <div style="text-align: right; font-size: 11px; margin-top: 15px; color: #888;">
                <p id="ultimo-usuario-info"></p>
            </div>
        </div>
    </div>

    <script>
        // Registro PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado!', reg))
                    .catch(err => console.log('Erro no SW:', err));
            });
        }

        // L√≥gica do App
        document.addEventListener('DOMContentLoaded', () => {
            // Elementos Login
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            const loginError = document.getElementById('login-error');

            // Elementos DOM Principais
            const formReserva = document.getElementById('form-reserva');
            const tabelaReservasBody = document.querySelector('#tabela-reservas tbody');
            const btnFormReserva = document.getElementById('btn-form-reserva');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');
            const loadingOverlay = document.getElementById('loading-overlay');
            const mensagemSucesso = document.getElementById('mensagem-sucesso');
            const ultimoUsuarioInfo = document.getElementById('ultimo-usuario-info');

            // Inputs do Form
            const contatoInput = document.getElementById('contato');
            const usuarioInput = document.getElementById('usuario');
            const observacoesInput = document.getElementById('observacoes');
            const dataInput = document.getElementById('data');
            const descricaoInput = document.getElementById('descricao');

            // Filtros e Bot√µes
            const filtroStatusSelect = document.getElementById('filtro-status');
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            const filtroPesquisaInput = document.getElementById('filtro-pesquisa'); 
            const qtdPorPaginaSelect = document.getElementById('qtd-por-pagina');
            const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
            const gerarPdfBtn = document.getElementById('gerar-pdf-btn');
            const gerarCsvBtn = document.getElementById('gerar-csv-btn');
            const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');

            // View Toggles
            const btnViewLista = document.getElementById('btn-view-lista');
            const btnViewCalendario = document.getElementById('btn-view-calendario');
            const sectionLista = document.getElementById('section-lista');
            const sectionCalendario = document.getElementById('section-calendario');

            // Cards e Pagina√ß√£o
            const totalReservasElement = document.getElementById('total-reservas');
            const totalConfirmadasElement = document.getElementById('total-confirmadas');
            const totalCanceladasElement = document.getElementById('total-canceladas');
            const reservas7diasElement = document.getElementById('reservas-7dias');
            const reservas7diasCard = document.getElementById('reservas-7dias-card');
            const paginationContainer = document.getElementById('pagination-container');

            // Vari√°veis de Estado
            let reservaParaEditar = null;
            let itemsPerPage = 30;
            let currentPage = 1;
            let reservas = [];
            let calendarInstance = null;

            // --- Carregar Usu√°rio do LocalStorage ---
            const usuarioSalvo = localStorage.getItem('reserva_clube_usuario');
            if (usuarioSalvo) usuarioInput.value = usuarioSalvo;

            // --- Configura√ß√£o Firebase ---
            const firebaseConfig = {
                apiKey: "AIzaSyDut5CV-mDqnuKV0MH8MM2ivOQMP-AF94E",
                authDomain: "reserva-b5ff4.firebaseapp.com",
                databaseURL: "https://reserva-b5ff4-default-rtdb.firebaseio.com",
                projectId: "reserva-b5ff4",
                storageBucket: "reserva-b5ff4.firebasestorage.app",
                messagingSenderId: "540617636797",
                appId: "1:540617636797:web:5081ca29f77cb9c5fab0d4"
            };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();
            const reservasRef = database.ref('reservas');
            
            // --- Fun√ß√£o de Loading ---
            function toggleLoading(show) {
                show ? loadingOverlay.classList.remove('hidden') : loadingOverlay.classList.add('hidden');
            }

            // --- L√≥gica de Autentica√ß√£o (LOGIN) ---
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Usu√°rio logado
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    carregarDados();
                } else {
                    // Usu√°rio deslogado
                    loginContainer.style.display = 'flex';
                    appContainer.style.display = 'none';
                    reservas = [];
                }
            });

            btnLogin.addEventListener('click', () => {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                
                if (!email || !password) {
                    alert('Por favor, preencha e-mail e senha.');
                    return;
                }

                toggleLoading(true);
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        loginError.style.display = 'none';
                    })
                    .catch((error) => {
                        console.error("Erro Login:", error);
                        loginError.style.display = 'block';
                        loginError.textContent = "Erro: " + error.message;
                        if(error.code === 'auth/wrong-password') loginError.textContent = "Senha incorreta.";
                        if(error.code === 'auth/user-not-found') loginError.textContent = "Usu√°rio n√£o encontrado.";
                    })
                    .finally(() => toggleLoading(false));
            });

            btnLogout.addEventListener('click', () => {
                if(confirm("Deseja realmente sair?")) {
                    auth.signOut().then(() => window.location.reload());
                }
            });

            // Tecla Enter no Login
            loginPasswordInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') btnLogin.click();
            });

            // --- L√≥gica Principal do App ---
            function carregarDados() {
                reservasRef.on('value', (snapshot) => {
                    if(reservas.length === 0) toggleLoading(true);
                    
                    try {
                        const data = snapshot.val();
                        reservas = [];
                        if (data) {
                            for (let key in data) {
                                reservas.push({ ...data[key], id: key });
                            }
                        }
                        ordenarReservas();
                        renderizarTabela(); 
                        if(calendarInstance && !sectionCalendario.classList.contains('hidden')) {
                            inicializarOuAtualizarCalendario(); 
                        }
                        atualizarUltimoUsuarioNaPagina();
                        atualizarResumo();
                    } catch (error) {
                        console.error("Erro:", error);
                    } finally {
                        toggleLoading(false);
                    }
                });
            }

            // --- Gerenciamento de Views ---
            btnViewLista.addEventListener('click', () => trocarView('lista'));
            btnViewCalendario.addEventListener('click', () => trocarView('calendario'));

            function trocarView(view) {
                if (view === 'lista') {
                    sectionLista.classList.remove('hidden');
                    sectionCalendario.classList.add('hidden');
                    btnViewLista.classList.add('active');
                    btnViewCalendario.classList.remove('active');
                } else {
                    sectionLista.classList.add('hidden');
                    sectionCalendario.classList.remove('hidden');
                    btnViewLista.classList.remove('active');
                    btnViewCalendario.classList.add('active');
                    setTimeout(() => inicializarOuAtualizarCalendario(), 100);
                }
            }

            // --- Calend√°rio ---
            function inicializarOuAtualizarCalendario() {
                const calendarEl = document.getElementById('calendar');
                const eventosCalendario = reservas.map(res => {
                    let cor = '#6c757d'; 
                    if (res.status === 'Confirmado') cor = '#28a745';
                    if (res.status === 'Reservado') cor = '#007bff';
                    if (res.status === 'Cancelado') cor = '#dc3545';
                    
                    return {
                        id: res.id,
                        title: `${res.descricao} (${res.responsavel})`,
                        start: res.data,
                        color: cor,
                        allDay: true,
                        extendedProps: { status: res.status, contato: res.contato }
                    };
                });

                if (calendarInstance) {
                    calendarInstance.removeAllEvents();
                    calendarInstance.addEventSource(eventosCalendario);
                    calendarInstance.render();
                } else {
                    calendarInstance = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'pt-br',
                        headerToolbar: {
                            left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth'
                        },
                        buttonText: { today: 'Hoje', month: 'M√™s', list: 'Lista' },
                        events: eventosCalendario,
                        eventClick: function(info) {
                            trocarView('lista');
                            setTimeout(() => {
                                editarReserva(info.event.id);
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                            }, 100);
                        }
                    });
                    calendarInstance.render();
                }
            }

            // --- Submit Form ---
            formReserva.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!contatoInput.value || !usuarioInput.value) { alert('Preencha os campos obrigat√≥rios.'); return; }
                
                const dataSelecionada = new Date(dataInput.value + 'T00:00:00');
                const dataAtual = new Date(); dataAtual.setHours(0, 0, 0, 0);

                if (dataSelecionada < dataAtual && !reservaParaEditar) {
                     if(!confirm("Aten√ß√£o: Data passada. Continuar?")) return;
                }

                const conflitoExistente = reservas.some(reserva => 
                    reserva.data === dataInput.value &&
                    reserva.descricao.toLowerCase() === descricaoInput.value.toLowerCase() &&
                    reserva.status === 'Confirmado' &&
                    (!reservaParaEditar || reserva.id !== reservaParaEditar.id)
                );

                if (conflitoExistente) {
                    alert('J√° existe reserva CONFIRMADA para esta data/local.');
                    return;
                }

                localStorage.setItem('reserva_clube_usuario', usuarioInput.value);

                const dadosReserva = {
                    data: dataInput.value,
                    descricao: descricaoInput.value,
                    responsavel: document.getElementById('responsavel').value,
                    contato: contatoInput.value,
                    observacoes: observacoesInput.value,
                    ultimoUsuario: usuarioInput.value
                };
                
                btnFormReserva.disabled = true;
                toggleLoading(true);

                if (reservaParaEditar) {
                    dadosReserva.status = reservaParaEditar.status; 
                    reservasRef.child(reservaParaEditar.id).update(dadosReserva)
                        .then(() => { mostrarMensagemSucesso("Atualizado!"); resetarFormulario(); })
                        .finally(() => { btnFormReserva.disabled = false; toggleLoading(false); });
                } else {
                    dadosReserva.status = 'Reservado';
                    reservasRef.push(dadosReserva)
                        .then(() => { mostrarMensagemSucesso("Criado!"); const u = usuarioInput.value; formReserva.reset(); usuarioInput.value = u; })
                        .finally(() => { btnFormReserva.disabled = false; toggleLoading(false); });
                }
            });

            contatoInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';
                if (value.length > 0) formattedValue = '(' + value.substring(0, 2);
                if (value.length >= 3) formattedValue += ') ' + value.substring(2, 7);
                if (value.length >= 8) formattedValue += '-' + value.substring(7, 11);
                e.target.value = formattedValue;
            });

            const aplicarFiltros = () => { currentPage = 1; renderizarTabela(); };
            filtroStatusSelect.addEventListener('change', aplicarFiltros);
            dataInicioInput.addEventListener('change', aplicarFiltros);
            dataFimInput.addEventListener('change', aplicarFiltros);
            filtroPesquisaInput.addEventListener('input', aplicarFiltros);
            qtdPorPaginaSelect.addEventListener('change', (e) => {
                itemsPerPage = e.target.value === 'all' ? 99999 : parseInt(e.target.value);
                aplicarFiltros();
            });
            btnLimparFiltros.addEventListener('click', () => {
                filtroStatusSelect.value = 'ativos';
                dataInicioInput.value = ''; dataFimInput.value = ''; filtroPesquisaInput.value = '';
                qtdPorPaginaSelect.value = '30'; itemsPerPage = 30; aplicarFiltros();
            });

            gerarPdfBtn.addEventListener('click', () => {
                if (sectionCalendario.classList.contains('active') || !sectionCalendario.classList.contains('hidden')) {
                    alert("Volte para a Lista para gerar PDF."); return;
                }
                const tabelaParaPdf = document.getElementById('tabela-para-pdf');
                const linhas = document.querySelectorAll('#tabela-reservas tbody tr');
                const thAcoes = document.querySelector('th:last-child');
                const tdAcoes = document.querySelectorAll('td:last-child');
                thAcoes.style.display = 'none'; tdAcoes.forEach(td => td.style.display = 'none');
                linhas.forEach(linha => linha.style.backgroundColor = window.getComputedStyle(linha).backgroundColor);

                html2pdf().set({ margin: 5, filename: 'relatorio.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }).from(tabelaParaPdf).save()
                .then(() => { thAcoes.style.display = ''; tdAcoes.forEach(td => td.style.display = ''); linhas.forEach(linha => linha.style.backgroundColor = ''); });
            });

            gerarCsvBtn.addEventListener('click', () => {
                const dadosTabela = []; const BOM = "\uFEFF"; 
                dadosTabela.push(['Data', 'Descricao', 'Responsavel', 'Contato', 'Observacoes', 'Status', 'Criador'].join(';'));
                filtrarReservas().forEach(reserva => {
                    dadosTabela.push([
                        formatarData(reserva.data), `"${reserva.descricao}"`, `"${reserva.responsavel}"`,
                        reserva.contato, `"${(reserva.observacoes||'').replace(/(\r\n|\n|\r)/gm, " ")}"`,
                        reserva.status, reserva.ultimoUsuario
                    ].join(';'));
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + BOM + dadosTabela.join('\n')));
                link.setAttribute("download", "reservas.csv");
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            });

            fecharPaginaBtn.addEventListener('click', () => window.close());
            
            tabelaReservasBody.addEventListener('click', (e) => {
                const tr = e.target.closest('tr'); if (!tr) return;
                const id = tr.dataset.id;
                if (e.target.classList.contains('btn-editar')) editarReserva(id);
                else if (e.target.classList.contains('btn-excluir')) {
                    if (confirm("Excluir permanentemente?")) reservasRef.child(id).remove();
                }
                else if (e.target.classList.contains('status-badge')) abrirOpcoesStatus(id, e.target.closest('td'));
            });

            btnCancelarEdicao.addEventListener('click', resetarFormulario);

            function formatarData(d) { if (!d) return '-'; const [a, m, D] = d.split('-'); return `${D}/${m}/${a}`; }
            function editarReserva(id) {
                reservaParaEditar = reservas.find(r => r.id === id);
                if (reservaParaEditar) {
                    document.getElementById('data').value = reservaParaEditar.data;
                    document.getElementById('descricao').value = reservaParaEditar.descricao;
                    document.getElementById('responsavel').value = reservaParaEditar.responsavel;
                    document.getElementById('contato').value = reservaParaEditar.contato;
                    document.getElementById('observacoes').value = reservaParaEditar.observacoes || '';
                    document.getElementById('usuario').value = reservaParaEditar.ultimoUsuario || usuarioInput.value;
                    btnFormReserva.textContent = "Salvar Altera√ß√µes";
                    btnFormReserva.style.backgroundColor = "#ffc107"; btnFormReserva.style.color = "#000";
                    btnCancelarEdicao.style.display = "inline-block";
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
            function resetarFormulario() {
                const u = usuarioInput.value; formReserva.reset(); usuarioInput.value = u;
                btnFormReserva.textContent = "Adicionar Reserva";
                btnFormReserva.style.backgroundColor = "#28a745"; btnFormReserva.style.color = "#fff";
                btnCancelarEdicao.style.display = "none"; reservaParaEditar = null;
            }
            function mostrarMensagemSucesso(msg) {
                mensagemSucesso.textContent = msg; mensagemSucesso.style.display = 'block';
                setTimeout(() => { mensagemSucesso.style.display = 'none'; }, 3000);
            }
            function ordenarReservas() { reservas.sort((a, b) => new Date(a.data) - new Date(b.data)); }

            function atualizarResumo() {
                const total = reservas.length;
                const confirmadas = reservas.filter(res => res.status === 'Confirmado').length;
                const canceladas = reservas.filter(res => res.status === 'Cancelado').length;
                const hoje = new Date(); hoje.setHours(0,0,0,0);
                const limit = new Date(); limit.setDate(hoje.getDate()+7);
                const prox = reservas.filter(res => {
                    const d = new Date(res.data+'T00:00:00');
                    return d >= hoje && d <= limit && (res.status === 'Reservado' || res.status === 'Confirmado');
                }).length;
                totalReservasElement.textContent = total; totalConfirmadasElement.textContent = confirmadas;
                totalCanceladasElement.textContent = canceladas; reservas7diasElement.textContent = prox;
                if(prox > 0) reservas7diasCard.classList.add('alerta-vermelho'); else reservas7diasCard.classList.remove('alerta-vermelho');
            }

            function filtrarReservas() {
                const status = filtroStatusSelect.value;
                const inicio = dataInicioInput.value; const fim = dataFimInput.value;
                const term = filtroPesquisaInput.value.toLowerCase();
                return reservas.filter(res => {
                    let sValido = (status === 'ativos') ? (res.status==='Reservado'||res.status==='Confirmado') : (status === 'todos' ? true : res.status.toLowerCase() === status);
                    const d = new Date(res.data+'T00:00:00');
                    const dOk = (!inicio || d >= new Date(inicio+'T00:00:00')) && (!fim || d <= new Date(fim+'T00:00:00'));
                    const tOk = term==='' || res.responsavel.toLowerCase().includes(term) || res.descricao.toLowerCase().includes(term) || (res.observacoes||'').toLowerCase().includes(term);
                    return sValido && dOk && tOk;
                });
            }

            function renderizarTabela() {
                tabelaReservasBody.innerHTML = '';
                const filtradas = filtrarReservas();
                const totalPages = Math.ceil(filtradas.length / itemsPerPage) || 1;
                if (currentPage > totalPages) currentPage = totalPages;
                const pageData = filtradas.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                
                if (pageData.length === 0) tabelaReservasBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">Vazio.</td></tr>';

                pageData.forEach(res => {
                    const tr = document.createElement('tr'); tr.dataset.id = res.id;
                    if(res.status==='Reservado') tr.classList.add('reservado-row');
                    else if(res.status==='Confirmado') tr.classList.add('confirmado-row');
                    else if(res.status==='Cancelado') tr.classList.add('cancelado-row');
                    else if(res.status==='Realizado') tr.classList.add('realizado-row');
                    
                    tr.innerHTML = `
                        <td style="text-align:center;">${formatarData(res.data)}</td>
                        <td><strong>${res.descricao}</strong></td>
                        <td>${res.responsavel}</td>
                        <td><a href="https://wa.me/55${res.contato.replace(/\D/g,'')}" target="_blank" style="text-decoration:none; color: #28a745; font-weight:bold;">üì± ${res.contato}</a></td>
                        <td style="font-size: 11px; color: #555;">${res.observacoes || ''}</td>
                        <td style="text-align:center;"><span class="status-badge badge-${res.status.toLowerCase()}">${res.status}</span></td>
                        <td style="text-align:center;"><div style="font-size:10px; color:#666; margin-bottom:4px;">Por: ${res.ultimoUsuario||'?'}</div>
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="btn-editar" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-excluir" title="Excluir">üóëÔ∏è</button>
                        </div></td>
                    `;
                    tabelaReservasBody.appendChild(tr);
                });
                renderizarPaginacao(totalPages);
            }

            function renderizarPaginacao(total) {
                paginationContainer.innerHTML = '';
                const btn = (t, p, a, d) => {
                    const b = document.createElement('button'); b.textContent = t; b.className = `page-button ${a?'active':''} ${d?'disabled':''}`;
                    if(!d) b.onclick = () => { currentPage = p; renderizarTabela(); };
                    return b;
                };
                paginationContainer.appendChild(btn('¬´', currentPage-1, false, currentPage===1));
                for(let i=Math.max(1, currentPage-2); i<=Math.min(total, currentPage+2); i++) paginationContainer.appendChild(btn(i, i, i===currentPage));
                paginationContainer.appendChild(btn('¬ª', currentPage+1, false, currentPage>=total));
            }

            function abrirOpcoesStatus(id, cell) {
                if(cell.querySelector('select')) return;
                const res = reservas.find(r => r.id === id); if(!res) return;
                cell.innerHTML = `<select style="padding:5px; border-radius:4px;"><option value="Reservado">Reservado</option><option value="Confirmado">Confirmado</option><option value="Cancelado">Cancelado</option><option value="Realizado">Realizado</option></select>`;
                const sel = cell.querySelector('select'); sel.value = res.status; sel.focus();
                const save = () => {
                    if(sel.value !== res.status) reservasRef.child(id).update({status: sel.value}).then(()=>mostrarMensagemSucesso("Status ok!"));
                    else renderizarTabela();
                };
                sel.addEventListener('blur', save); sel.addEventListener('change', () => sel.blur());
            }

            function atualizarUltimoUsuarioNaPagina() {
                reservasRef.orderByKey().limitToLast(1).once('value', (s) => {
                    const d = s.val(); if(d) { const k = Object.keys(d)[0]; ultimoUsuarioInfo.textContent = `√öltimo registro por: ${d[k].ultimoUsuario} em ${formatarData(d[k].data)}`; }
                });
            }
        });
    </script>
</body>
</html>